
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="This is a repository for managing embarassingly parallel experiments with Hatchet.">
      
      
        <meta name="author" content="Sam Wolk">
      
      
        <link rel="canonical" href="https://szvsw.github.io/scythe/blog/building-scythe/">
      
      
        <link rel="prev" href="../..">
      
      
      
      <link rel="icon" href="../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.6.15">
    
    
      
        <title>Building Scythe - Scythe</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.342714a4.min.css">
      
        
        <link rel="stylesheet" href="../../assets/stylesheets/palette.06af60db.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../assets/_mkdocstrings.css">
    
    <script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="white" data-md-color-accent="deep-orange">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#building-a-toolkit-for-embarrassingly-parallel-experiments-using-hatchet-sstdev" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../.." title="Scythe" class="md-header__button md-logo" aria-label="Scythe" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Scythe
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Building Scythe
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme: light)" data-md-color-scheme="default" data-md-color-primary="white" data-md-color-accent="deep-orange"  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_0">
    
      <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_1" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a4 4 0 0 0-4 4 4 4 0 0 0 4 4 4 4 0 0 0 4-4 4 4 0 0 0-4-4m0 10a6 6 0 0 1-6-6 6 6 0 0 1 6-6 6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="(prefers-color-scheme: dark)" data-md-color-scheme="slate" data-md-color-primary="black" data-md-color-accent="deep-orange"  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_1">
    
      <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_0" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 18c-.89 0-1.74-.2-2.5-.55C11.56 16.5 13 14.42 13 12s-1.44-4.5-3.5-5.45C10.26 6.2 11.11 6 12 6a6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg>
      </label>
    
  
</form>
      
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
      <div class="md-header__source">
        <a href="https://github.com/szvsw/scythe" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8M97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg>
  </div>
  <div class="md-source__repository">
    szvsw/scythe
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="Scythe" class="md-nav__button md-logo" aria-label="Scythe" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    Scythe
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/szvsw/scythe" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8M97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg>
  </div>
  <div class="md-source__repository">
    szvsw/scythe
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Home
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
      
        
      
    
    
    
      
        
        
      
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2" checked>
        
          
          <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    Blog
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            Blog
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  
  <span class="md-ellipsis">
    Building Scythe
    
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  
  <span class="md-ellipsis">
    Building Scythe
    
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#context" class="md-nav__link">
    <span class="md-ellipsis">
      Context
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Context">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#motivation-for-writeup" class="md-nav__link">
    <span class="md-ellipsis">
      Motivation for writeup
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#background" class="md-nav__link">
    <span class="md-ellipsis">
      Background
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#development-history" class="md-nav__link">
    <span class="md-ellipsis">
      Development history
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Development history">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#the-roads-not-taken" class="md-nav__link">
    <span class="md-ellipsis">
      The road(s) not taken...
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#so-why-stick-with-hatchet" class="md-nav__link">
    <span class="md-ellipsis">
      So why stick with Hatchet?
    </span>
  </a>
  
    <nav class="md-nav" aria-label="So why stick with Hatchet?">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#dags" class="md-nav__link">
    <span class="md-ellipsis">
      DAGs
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#retrydurability-in-dags" class="md-nav__link">
    <span class="md-ellipsis">
      Retry/Durability in DAGs
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#worker-tags" class="md-nav__link">
    <span class="md-ellipsis">
      Worker Tags
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#scythe-from-a-user-perspective" class="md-nav__link">
    <span class="md-ellipsis">
      Scythe - from a user perspective
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#scythe-from-a-developer-perspective" class="md-nav__link">
    <span class="md-ellipsis">
      Scythe - from a developer perspective
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Scythe - from a developer perspective">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#requirements" class="md-nav__link">
    <span class="md-ellipsis">
      Requirements
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#core-design-decisions" class="md-nav__link">
    <span class="md-ellipsis">
      Core design decisions
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Core design decisions">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#middleware-for-individual-simulation-tasks" class="md-nav__link">
    <span class="md-ellipsis">
      Middleware for individual simulation tasks
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#scattergather-divide-conquer" class="md-nav__link">
    <span class="md-ellipsis">
      Scatter/gather: divide &amp; conquer
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#dealing-with-thick-thin-payloads" class="md-nav__link">
    <span class="md-ellipsis">
      Dealing with thick &amp; thin payloads
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#cloud-infrastructure" class="md-nav__link">
    <span class="md-ellipsis">
      Cloud Infrastructure
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Cloud Infrastructure">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#containerization" class="md-nav__link">
    <span class="md-ellipsis">
      Containerization
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Containerization">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#dockerfile-example" class="md-nav__link">
    <span class="md-ellipsis">
      Dockerfile example
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#docker-compose-example" class="md-nav__link">
    <span class="md-ellipsis">
      Docker Compose example
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#deploying-containers" class="md-nav__link">
    <span class="md-ellipsis">
      Deploying containers
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#building-a-mini-cluster-with-your-lab-desktops-overnight-spare-cycles" class="md-nav__link">
    <span class="md-ellipsis">
      Building a mini-cluster with your lab desktops' overnight spare cycles
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#self-hosting-hatchet-as-an-intro-to-cloud-configuration" class="md-nav__link">
    <span class="md-ellipsis">
      Self-hosting Hatchet as an intro to cloud configuration
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Self-hosting Hatchet as an intro to cloud configuration">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#the-vpc" class="md-nav__link">
    <span class="md-ellipsis">
      The VPC
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#public-vs-private-subnets" class="md-nav__link">
    <span class="md-ellipsis">
      Public vs Private Subnets
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#security-groups" class="md-nav__link">
    <span class="md-ellipsis">
      Security Groups
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#deploying-the-hatchet-service" class="md-nav__link">
    <span class="md-ellipsis">
      Deploying the Hatchet service
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#worker-nodes" class="md-nav__link">
    <span class="md-ellipsis">
      Worker nodes
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Worker nodes">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#creating-an-environment-and-deploying-a-handful-of-workers" class="md-nav__link">
    <span class="md-ellipsis">
      Creating an environment and deploying a handful of workers
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#deploying-a-lot-of-workers-at-once" class="md-nav__link">
    <span class="md-ellipsis">
      Deploying a lot of workers at once
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#differentiating-worker-types" class="md-nav__link">
    <span class="md-ellipsis">
      Differentiating worker types
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#context" class="md-nav__link">
    <span class="md-ellipsis">
      Context
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Context">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#motivation-for-writeup" class="md-nav__link">
    <span class="md-ellipsis">
      Motivation for writeup
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#background" class="md-nav__link">
    <span class="md-ellipsis">
      Background
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#development-history" class="md-nav__link">
    <span class="md-ellipsis">
      Development history
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Development history">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#the-roads-not-taken" class="md-nav__link">
    <span class="md-ellipsis">
      The road(s) not taken...
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#so-why-stick-with-hatchet" class="md-nav__link">
    <span class="md-ellipsis">
      So why stick with Hatchet?
    </span>
  </a>
  
    <nav class="md-nav" aria-label="So why stick with Hatchet?">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#dags" class="md-nav__link">
    <span class="md-ellipsis">
      DAGs
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#retrydurability-in-dags" class="md-nav__link">
    <span class="md-ellipsis">
      Retry/Durability in DAGs
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#worker-tags" class="md-nav__link">
    <span class="md-ellipsis">
      Worker Tags
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#scythe-from-a-user-perspective" class="md-nav__link">
    <span class="md-ellipsis">
      Scythe - from a user perspective
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#scythe-from-a-developer-perspective" class="md-nav__link">
    <span class="md-ellipsis">
      Scythe - from a developer perspective
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Scythe - from a developer perspective">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#requirements" class="md-nav__link">
    <span class="md-ellipsis">
      Requirements
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#core-design-decisions" class="md-nav__link">
    <span class="md-ellipsis">
      Core design decisions
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Core design decisions">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#middleware-for-individual-simulation-tasks" class="md-nav__link">
    <span class="md-ellipsis">
      Middleware for individual simulation tasks
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#scattergather-divide-conquer" class="md-nav__link">
    <span class="md-ellipsis">
      Scatter/gather: divide &amp; conquer
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#dealing-with-thick-thin-payloads" class="md-nav__link">
    <span class="md-ellipsis">
      Dealing with thick &amp; thin payloads
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#cloud-infrastructure" class="md-nav__link">
    <span class="md-ellipsis">
      Cloud Infrastructure
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Cloud Infrastructure">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#containerization" class="md-nav__link">
    <span class="md-ellipsis">
      Containerization
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Containerization">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#dockerfile-example" class="md-nav__link">
    <span class="md-ellipsis">
      Dockerfile example
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#docker-compose-example" class="md-nav__link">
    <span class="md-ellipsis">
      Docker Compose example
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#deploying-containers" class="md-nav__link">
    <span class="md-ellipsis">
      Deploying containers
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#building-a-mini-cluster-with-your-lab-desktops-overnight-spare-cycles" class="md-nav__link">
    <span class="md-ellipsis">
      Building a mini-cluster with your lab desktops' overnight spare cycles
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#self-hosting-hatchet-as-an-intro-to-cloud-configuration" class="md-nav__link">
    <span class="md-ellipsis">
      Self-hosting Hatchet as an intro to cloud configuration
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Self-hosting Hatchet as an intro to cloud configuration">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#the-vpc" class="md-nav__link">
    <span class="md-ellipsis">
      The VPC
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#public-vs-private-subnets" class="md-nav__link">
    <span class="md-ellipsis">
      Public vs Private Subnets
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#security-groups" class="md-nav__link">
    <span class="md-ellipsis">
      Security Groups
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#deploying-the-hatchet-service" class="md-nav__link">
    <span class="md-ellipsis">
      Deploying the Hatchet service
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#worker-nodes" class="md-nav__link">
    <span class="md-ellipsis">
      Worker nodes
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Worker nodes">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#creating-an-environment-and-deploying-a-handful-of-workers" class="md-nav__link">
    <span class="md-ellipsis">
      Creating an environment and deploying a handful of workers
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#deploying-a-lot-of-workers-at-once" class="md-nav__link">
    <span class="md-ellipsis">
      Deploying a lot of workers at once
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#differentiating-worker-types" class="md-nav__link">
    <span class="md-ellipsis">
      Differentiating worker types
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  


  
  


<h1 id="building-a-toolkit-for-embarrassingly-parallel-experiments-using-hatchet-sstdev">Building a toolkit for embarrassingly parallel experiments using Hatchet + SST.dev<a class="headerlink" href="#building-a-toolkit-for-embarrassingly-parallel-experiments-using-hatchet-sstdev" title="Permanent link">#</a></h1>
<p>In my experience helping colleagues with their research projects,
academic researchers and engineers (as in actual engineers, not SWEs) often have the ability to define their
experiments via input and output specs fairly well and would love to run at large scales,
but often get limited by a lack of experience with distributed computing techniques,
eg. artifact infil- and exfiltration, handling errors, interacting with supercomputing schedulers,
dealing with cloud infrastructure, etc.</p>
<p>As part of the collaborative research process, I ended up developing - and re-developing -
my workflows for running both my own and my colleagues' embarrassingly parallel experiments,
which eventually resulted in the creation of a library I've called <a href="https://github.com/szvsw/scythe">Scythe</a>.
Scythe is a lightweight tool which helps you seed and reap (scatter and gather)
embarrassingly parallel experiments via the asynchronous distributed queue <a href="https://hatchet.run">Hatchet</a>.</p>
<p>The goal of Scythe is to abstract away some of those unfamiliar cloud/distributed computing
details to let researchers focus on what they are familiar with (i.e. writing consistent
input and output schemas and the computation logic that transforms data from inputs into
outputs) while automating the boring but necessary work to run millions of simulations (e.g.
serializing data to and from cloud buckets, configuring queues, etc).</p>
<p>There are of course lots of data engineering orchestration tools out there already, but Scythe
is a bit more lightweight and hopefully a little simpler to use, at the expense of fewer bells and whistles (for now)
like robust dataset lineage, ui/ux for browsing previous experiments etc.</p>
<p><a href="https://hatchet.run">Hatchet</a> is already very easy (and fun!) to use for newcomers to
distributed computing, so I recommend checking out their docs - you might be better off
simply directly running Hatchet! Scythe is just a lightweight modular layer on top of it
which is really tailored to the use case of generating large datasets of consistently structured
experiment inputs and outputs. Another option you might check out would be something like <a href="https://coiled.io/">Coiled + Dask</a>.</p>
<h2 id="context">Context<a class="headerlink" href="#context" title="Permanent link">#</a></h2>
<h3 id="motivation-for-writeup">Motivation for writeup<a class="headerlink" href="#motivation-for-writeup" title="Permanent link">#</a></h3>
<p>I'm writing this for a few reasons -</p>
<ul>
<li>to condense some of the knowledge that I think is most useful for other people looking
  to get into large-scale distributed cloud computing (large at least in the context of
  academia, specifically engineering/applied ML fields, as opposed to say AI research) who
  might otherwise take a while to get up to speed on stuff, and/or who feel extensive pain trying
  to learn their institution's archaic and arcane supercomputing cluster patterns (ahem) when all
  they want to do is just run a shitload of simulations.</li>
<li>to give back to and participate in the community of developers who share their experiences
  and challenges on the internet, and in so doing hopefully help at least one other person
  learn and grow, the way countless others have helped me with their blog posts, videos, tutorials,
  books, etc.</li>
<li>to reflect on some of the work I've been doing in the course of my Masters/PhD that is not
  really relevant to reserach publications, but which is arguably more complex and valuable
  from a personal skill development perspective.</li>
</ul>
<p>This is meant to be part dev-diary, part primer on using Scythe, and part primer on deploying
distributed computing applications in the cloud which I can share with classmates/colleagues.
Depending on your interests, you will probably want to skip various sections of it.</p>
<h3 id="background">Background<a class="headerlink" href="#background" title="Permanent link">#</a></h3>
<p>Buildings account for ~40% of global emissions, mostly via space heating and cooling. My
research @ the MIT Sustainable Design Lab (School of Architecture+Planning) is focused on
decarbonizing the built environment by developing tools which leverage distributed computing
and machine learning to accelerate large-scale bottom up building energy modeling within retrofit
planning frameworks used by policymakers, utility operators, real estate portfolio owners, and
homeowners.</p>
<p>As part of that work, I often work on research projects/experiments for myself or colleagues
with anywhere from 1e3 to 1e7 building energy simulations, and so have had to develop workflows
which can handle operating at the requisite scale.</p>
<blockquote>
<p><em>You are probably immediately wondering what the carbon cost of the research is. Across all
the simulations I've invoked since starting in the early 2020s, assuming some carbon factors and PUE factors for the AWS us-east-1
data center, I've estimated it to be equivalent something on the order of 1 month of emissions associated with a
typical single family home in New England. <br><br> Definitely not nothing, but definitely small enough
that if just one or two additional homes or businesses install a heat pump and do some airsealing
that wouldn't have otherwise, it will make the research net carbon negative. Could there have been
a better use for all that carbon spent on compute which might have resulted in even greater carbon leverage?
Maybe - probably - but this is what I do and work on and enjoy, so for now I just hope for the best.</em></p>
</blockquote>
<h2 id="development-history">Development history<a class="headerlink" href="#development-history" title="Permanent link">#</a></h2>
<p>Over the past few years, I've worked on and off on the system I use when I need to run
a few million simulations at a time, including rewriting things from the ground up a few
times. There's probably a component of that impulse to rewrite which is just wanting to try out a fancy new
thing I've learned about each time, another component which is wanting to grow as a
developer by re-evaluating and re-designing something to achieve the same goal but with
lessons learned and a better eye for what would be useful functionality, and finally a
component of that is to satisfy the desire to get things to a place where someone else
can actually take advantage of and make use of some of my work product in the open source
spirit.</p>
<ul>
<li><code>vminus2</code>: Spring 2023: Earning the word <code>embarrassing</code>: embarrassingly parallel, and
  embarrassingly architected. Spin up a bunch of instances on <a href="https://paperspace.com">PaperSpace</a>
  (now owned by DigitalOcean) each with very high numbers of CPUs, open up virtual desktop
  via web UI, use <a href="https://github.com/tmux/tmux/wiki">tmux</a> to start 30-ish simulation
  processes per instance. Each process does ~1k-2k sims, writes an HDF file with all of its
  sim results to S3, eventually run a separate collector after completion to combine S3
  results.</li>
<li><code>vminus1</code>: Summer 2023 - Spring 2024: Roll my own. Use SQS to ingest a message for each
  different simuation, then spin up AWS Batch array job with a few thousand worker nodes
  (Fargate Spot) which chew through messages from the queue, exit after queue has been empty for
  some amount of time. Ugly attempts at dynamic leaf task invocation.</li>
<li><code>v0</code>: Summer 2024 - Spring 2025: Adopt a proper distributed asynchronous task framework - <a href="https://hatchet.run">Hatchet</a> (v0) - as the async distributed
  queue instead of the lower level SQS. Abstract common/shared scatter/gather logic to decouple simulation
  fanout patterns from underlying leaf tasks. Still create Hatchet worker nodes via AWS Batch
  (Fargate Spot). Use AWS Copilot CLI (blech) if self-deploying Hatchet, but mostly use
  managed Hatchet.</li>
<li><code>v1</code>: Summer 2025+: Adopt Hatchet v1, fully isolate experiment creation/tracking into
  re-usable extensible patterns including middleware for things like data infiltration/exfiltration
  by creating <a href="https://github.com/szvsw/scythe">Scythe</a>
  (<a href="https://github.com/szvsw/scythe-example">example usage</a>). Create simpler self-hosting
  config via <a href="https://sst.dev">sst.dev</a> in <a href="https://github.com/szvsw/hatchet-sst">HatchetSST</a>.</li>
</ul>
<h3 id="the-roads-not-taken">The road(s) not taken...<a class="headerlink" href="#the-roads-not-taken" title="Permanent link">#</a></h3>
<p>Celery is the most popular and common async task queue for Python, but I wanted to stay away
from it for a variety of reasons I won't get into here. It would not have been a bad choice though.</p>
<p>There's probably one main alternative solution which <em>might</em> be a better choice than what I have
settled on: <a href="https://coiled.io">Coiled</a> + <a href="https://dask.org">Dask</a>. It's pretty easy to use,
setup, get started with, easy to spin up a ton of compute very quickly, etc. I think had
I come across Coiled earlier, I might have just gone that route. I didn't come across it until
Fall 2024, and I had already put substantial design time into the version using Hatchet,
so there was a bit of a sunk cost thing going on there, but I also just genuinely really
liked Hatchet's design decisions and the team from hatchet had already
been super fun and easy to work with as I was stress-testing some of their managed infra,
so I felt it was worth it to continue with Hatchet - as well as for a variety of other reasons which I
probably will not get into in this post. I guess one of them is that software stack at
the building/real estate decarbonization planning SaaS startup that that I do ML engineering
work at (<a href="https://carbonsignal.com">CarbonSignal</a>) makes heavy use of Celery, and I would
like to eventually move us away from Celery to Hatchet if we ever do a refactor of the
async task management part of the stack, which we probably won't ("if it ain't broke..."),
but if we do I would at least like to be prepared to make an argument for switching.</p>
<p>There are of course other bits of tooling like Dagster, Airflow, Prefect etc that play a role
in workflow orchestration and data management, plus platforms like Weights &amp; Biases or Neptune.ai
that play a role in experiment tracking (I actually really like WandB and use it at CarbonSignal),
but I think these are mostly overkill in the context I am most typically working
(academic experiments run once or twice a month - if that - with a few million tasks in
each experiment).</p>
<p>If you have other recommendations you think I should check out, would love to discuss!</p>
<h3 id="so-why-stick-with-hatchet">So why stick with Hatchet?<a class="headerlink" href="#so-why-stick-with-hatchet" title="Permanent link">#</a></h3>
<p>I would say the top things that I find most useful in Hatchet over say Celery, or my self-rolled
SQS queues, or something like Coiled+Dask or any of the other options I looked at are:</p>
<h4 id="dags">DAGs<a class="headerlink" href="#dags" title="Permanent link">#</a></h4>
<p>Pretty great first class support for complex DAGs complete with detailed type-safety and payload validation.
I vastly prefer the design language here over Celery's mechanisms for building DAGs, and the
type safety via Pydantic is awesome, both at runtime and in dev (yes I know you can achieve
something similar with Celery but it is ugly). This was especially ugly in my early versions, where
I essentially would just have a worker track all of its results in memory and periodically
flush them to S3, rather than using a true scatter/gather DAG. It could also easily result
in lost compute if a node got shut down between flushes.</p>
<h4 id="retrydurability-in-dags">Retry/Durability in DAGs<a class="headerlink" href="#retrydurability-in-dags" title="Permanent link">#</a></h4>
<p>Fantastic retry/durable handling in DAGs, which for me plays a key role in greatly reducing
costs by removing most of the annoyances that come with running on spot capacity. Most queues have some form of acking receipt
on finish/retrying tasks, so that if a spot capacity worker gets reclaimed by AWS, the message/task
will still get processed by another worker node, but the retry durability unique to Hatchet
is especially important in scatter/gather style-tasks - if I've already allocated 5e6 out of 1e7 simulations,
I definitely don't want that first half getting allocated again if a spot capacity worker gets reclaimed by AWS!</p>
<p>Hatchet will automatically resume allocating simulations where the previous worker node left off when the
allocation task gets picked up again. Similarly, during collection, let's 5% of the simulations had failed
due to an uploaded artifact which had bad data in it (e.g. a weather file from a faulty weather station).
I can easily just retry those directly, and retrigger collection of all results - since I use
a recursive subdivision tree pattern for scattering and gathering tasks, Hatchet only re-runs
the branches of the tree that actually needed to be rerun. This retry+durability support
makes it stress-free to use spot capacity, which GREATLY reduces costs.</p>
<h4 id="worker-tags">Worker Tags<a class="headerlink" href="#worker-tags" title="Permanent link">#</a></h4>
<p>Being able to specify which node type a task should run on makes it a lot easier to efficiently
allocate compute. For instance, I know that my scatter/gather task needs relatively high memory
and benefits from multiple CPUs when it is assembling results files, while my leaf simulation
tasks are limited by essentially single core performance. I can easily just specify that
leaf tasks should be on 1vCPU/4GB nodes with an appropriate tag, and my scatter/gather task
need to be on 4vCPU/16GB nodes with an appropriate tag, and then when deploying cloud compute,
give the workers tags depending on what type of node they are on.</p>
<h2 id="scythe-from-a-user-perspective">Scythe - from a user perspective<a class="headerlink" href="#scythe-from-a-user-perspective" title="Permanent link">#</a></h2>
<p>Scythe is useful for running many parallel/concurrent simulations with a common I/O interface.
It abstracts away the logic of uploading and referencing artifacts, issuing simulations
and combining results into well-structured dataframes and parquet files.</p>
<p>After an experiment is finished, you will have a directory in your S3 bucket with the
following structure:</p>
<div class="language-text highlight"><pre><span></span><code><span id="__span-0-1"><a id="__codelineno-0-1" name="__codelineno-0-1" href="#__codelineno-0-1"></a>&lt;experiment_id&gt;/
</span><span id="__span-0-2"><a id="__codelineno-0-2" name="__codelineno-0-2" href="#__codelineno-0-2"></a>├──── &lt;version&gt;/
</span><span id="__span-0-3"><a id="__codelineno-0-3" name="__codelineno-0-3" href="#__codelineno-0-3"></a>│     ├──── &lt;datetime&gt;/
</span><span id="__span-0-4"><a id="__codelineno-0-4" name="__codelineno-0-4" href="#__codelineno-0-4"></a>│     │     ├──── manifest.yml
</span><span id="__span-0-5"><a id="__codelineno-0-5" name="__codelineno-0-5" href="#__codelineno-0-5"></a>│     │     ├──── experiment_io_spec.yml
</span><span id="__span-0-6"><a id="__codelineno-0-6" name="__codelineno-0-6" href="#__codelineno-0-6"></a>│     │     ├──── input_artifacts.yml
</span><span id="__span-0-7"><a id="__codelineno-0-7" name="__codelineno-0-7" href="#__codelineno-0-7"></a>│     │     ├──── specs.pq
</span><span id="__span-0-8"><a id="__codelineno-0-8" name="__codelineno-0-8" href="#__codelineno-0-8"></a>│     │     ├──── artifacts/
</span><span id="__span-0-9"><a id="__codelineno-0-9" name="__codelineno-0-9" href="#__codelineno-0-9"></a>│     │     │     ├──── &lt;file-ref-field-1&gt;/
</span><span id="__span-0-10"><a id="__codelineno-0-10" name="__codelineno-0-10" href="#__codelineno-0-10"></a>│     │     │     │     ├──── file1.ext
</span><span id="__span-0-11"><a id="__codelineno-0-11" name="__codelineno-0-11" href="#__codelineno-0-11"></a>│     │     │     │     └──── file2.ext
</span><span id="__span-0-12"><a id="__codelineno-0-12" name="__codelineno-0-12" href="#__codelineno-0-12"></a>│     │     │     └──── &lt;file-ref-field-1&gt;/
</span><span id="__span-0-13"><a id="__codelineno-0-13" name="__codelineno-0-13" href="#__codelineno-0-13"></a>│     │     │     │     ├──── file1.ext
</span><span id="__span-0-14"><a id="__codelineno-0-14" name="__codelineno-0-14" href="#__codelineno-0-14"></a>│     │     │     │     └──── file2.ext
</span><span id="__span-0-15"><a id="__codelineno-0-15" name="__codelineno-0-15" href="#__codelineno-0-15"></a>│     │     │     ...
</span><span id="__span-0-16"><a id="__codelineno-0-16" name="__codelineno-0-16" href="#__codelineno-0-16"></a>│     │     ├──── scatter-gather/
</span><span id="__span-0-17"><a id="__codelineno-0-17" name="__codelineno-0-17" href="#__codelineno-0-17"></a>│     │     │     ├──── input/
</span><span id="__span-0-18"><a id="__codelineno-0-18" name="__codelineno-0-18" href="#__codelineno-0-18"></a>│     │     │     └──── output/
</span><span id="__span-0-19"><a id="__codelineno-0-19" name="__codelineno-0-19" href="#__codelineno-0-19"></a>│     │     ├──── final/
</span><span id="__span-0-20"><a id="__codelineno-0-20" name="__codelineno-0-20" href="#__codelineno-0-20"></a>│     │     │     ├──── scalars.pq
</span><span id="__span-0-21"><a id="__codelineno-0-21" name="__codelineno-0-21" href="#__codelineno-0-21"></a>│     │     │     ├──── result_file_refs.pq
</span><span id="__span-0-22"><a id="__codelineno-0-22" name="__codelineno-0-22" href="#__codelineno-0-22"></a>│     │     │     ├──── &lt;user-dataframe&gt;.pq
</span><span id="__span-0-23"><a id="__codelineno-0-23" name="__codelineno-0-23" href="#__codelineno-0-23"></a>│     │     │     ├──── &lt;user-dataframe&gt;.pq
</span><span id="__span-0-24"><a id="__codelineno-0-24" name="__codelineno-0-24" href="#__codelineno-0-24"></a>│     │     │     ...
</span><span id="__span-0-25"><a id="__codelineno-0-25" name="__codelineno-0-25" href="#__codelineno-0-25"></a>│     │     ├──── results/
</span><span id="__span-0-26"><a id="__codelineno-0-26" name="__codelineno-0-26" href="#__codelineno-0-26"></a>│     │     │     ├──── &lt;file-ref-field-1&gt;/
</span><span id="__span-0-27"><a id="__codelineno-0-27" name="__codelineno-0-27" href="#__codelineno-0-27"></a>│     │     │     │     ├──── &lt;simulation-1-run-id&gt;.ext
</span><span id="__span-0-28"><a id="__codelineno-0-28" name="__codelineno-0-28" href="#__codelineno-0-28"></a>│     │     │     │     └──── &lt;simulation-2-run-id&gt;.ext
</span><span id="__span-0-29"><a id="__codelineno-0-29" name="__codelineno-0-29" href="#__codelineno-0-29"></a>│     │     │     └──── &lt;file-ref-field-2&gt;/
</span><span id="__span-0-30"><a id="__codelineno-0-30" name="__codelineno-0-30" href="#__codelineno-0-30"></a>│     │     │     │     ├──── &lt;simulation-1-run-id&gt;.ext
</span><span id="__span-0-31"><a id="__codelineno-0-31" name="__codelineno-0-31" href="#__codelineno-0-31"></a>│     │     │     │     └──── &lt;simulation-2-run-id&gt;.ext
</span><span id="__span-0-32"><a id="__codelineno-0-32" name="__codelineno-0-32" href="#__codelineno-0-32"></a>│     │     │     ...
</span><span id="__span-0-33"><a id="__codelineno-0-33" name="__codelineno-0-33" href="#__codelineno-0-33"></a>│     ├──── &lt;datetime&gt;/
</span><span id="__span-0-34"><a id="__codelineno-0-34" name="__codelineno-0-34" href="#__codelineno-0-34"></a>│     ...
</span><span id="__span-0-35"><a id="__codelineno-0-35" name="__codelineno-0-35" href="#__codelineno-0-35"></a>├──── &lt;version&gt;/
</span><span id="__span-0-36"><a id="__codelineno-0-36" name="__codelineno-0-36" href="#__codelineno-0-36"></a>...
</span></code></pre></div>
<p>In this example, we will demonstrate setting up a building energy simulation so we can
create a dataset of energy modeling results for use in training a surrogate model. In
fact, this experiment itself might just be one node in a larger DAG which handles automated
design space sampling, training, and progressively growing the training set + retraining
until error threshold metrics are satisfied. For now, we will just focus on a simple experiment
though.</p>
<p>To begin, we start by defining the schema of the inputs and outputs by inheriting from
the relevant classes imported from Scythe. The inputs will
ultimately be converted into dataframes (where the defined input fields are columns).
Similarly, the output schema fields will be used as columns of results dataframes
(and the input dataframe will actualy be used as a MultiIndex).</p>
<p>Note that <code>FileReference</code> inputs, which can be <code>HttpUrl | S3Url | pathlib.Path</code>, which are of
type <code>Path</code> will automatically be uploaded to S3 and re-referenced as S3 URIs.</p>
<p>Similarly, <code>FileReference</code> outputs which are of type <code>Path</code> will automatically get transferred
to S3 when each simulation task finishes and re-referenced as URIs, and registered in a
separate table of file outputs.</p>
<div class="language-py highlight"><pre><span></span><code><span id="__span-1-1"><a id="__codelineno-1-1" name="__codelineno-1-1" href="#__codelineno-1-1"></a><span class="kn">from</span><span class="w"> </span><span class="nn">pydantic</span><span class="w"> </span><span class="kn">import</span> <span class="n">Field</span>
</span><span id="__span-1-2"><a id="__codelineno-1-2" name="__codelineno-1-2" href="#__codelineno-1-2"></a><span class="kn">from</span><span class="w"> </span><span class="nn">scythe.base</span><span class="w"> </span><span class="kn">import</span> <span class="n">ExperimentInputSpec</span><span class="p">,</span> <span class="n">ExperimentOutputSpec</span>
</span><span id="__span-1-3"><a id="__codelineno-1-3" name="__codelineno-1-3" href="#__codelineno-1-3"></a><span class="kn">from</span><span class="w"> </span><span class="nn">scythe.utils.filesys</span><span class="w"> </span><span class="kn">import</span> <span class="n">FileReference</span>
</span><span id="__span-1-4"><a id="__codelineno-1-4" name="__codelineno-1-4" href="#__codelineno-1-4"></a>
</span><span id="__span-1-5"><a id="__codelineno-1-5" name="__codelineno-1-5" href="#__codelineno-1-5"></a><span class="k">class</span><span class="w"> </span><span class="nc">BuildingSimulationInput</span><span class="p">(</span><span class="n">ExperimentInputSpec</span><span class="p">):</span>
</span><span id="__span-1-6"><a id="__codelineno-1-6" name="__codelineno-1-6" href="#__codelineno-1-6"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Simulation inputs for a building energy model.&quot;&quot;&quot;</span>
</span><span id="__span-1-7"><a id="__codelineno-1-7" name="__codelineno-1-7" href="#__codelineno-1-7"></a>
</span><span id="__span-1-8"><a id="__codelineno-1-8" name="__codelineno-1-8" href="#__codelineno-1-8"></a>    <span class="n">r_value</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">default</span><span class="o">=...</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;The R-Value of the building [m2K/W]&quot;</span><span class="p">,</span> <span class="n">ge</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">le</span><span class="o">=</span><span class="mi">15</span><span class="p">)</span>
</span><span id="__span-1-9"><a id="__codelineno-1-9" name="__codelineno-1-9" href="#__codelineno-1-9"></a>    <span class="n">lpd</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">default</span><span class="o">=...</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Lighting power density [W/m2]&quot;</span><span class="p">,</span> <span class="n">ge</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">le</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
</span><span id="__span-1-10"><a id="__codelineno-1-10" name="__codelineno-1-10" href="#__codelineno-1-10"></a>    <span class="n">setpoint</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">default</span><span class="o">=...</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Thermostat setpoint [deg.C]&quot;</span><span class="p">,</span> <span class="n">ge</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span> <span class="n">le</span><span class="o">=</span><span class="mi">30</span><span class="p">)</span>
</span><span id="__span-1-11"><a id="__codelineno-1-11" name="__codelineno-1-11" href="#__codelineno-1-11"></a>    <span class="n">economizer</span><span class="p">:</span> <span class="n">Literal</span><span class="p">[</span><span class="s2">&quot;NoEconomizer&quot;</span><span class="p">,</span> <span class="s2">&quot;DifferentialDryBulb&quot;</span><span class="p">,</span> <span class="s2">&quot;DifferentialEnthalpy&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">default</span><span class="o">=...</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;The type of economizer to use&quot;</span><span class="p">)</span>
</span><span id="__span-1-12"><a id="__codelineno-1-12" name="__codelineno-1-12" href="#__codelineno-1-12"></a>    <span class="n">weather_file</span><span class="p">:</span> <span class="n">FileReference</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">default</span><span class="o">=...</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Weather file [.epw]&quot;</span><span class="p">)</span> <span class="c1"># (1)!</span>
</span><span id="__span-1-13"><a id="__codelineno-1-13" name="__codelineno-1-13" href="#__codelineno-1-13"></a>    <span class="n">design_day_file</span><span class="p">:</span> <span class="n">FileReference</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">default</span><span class="o">=...</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Weather file [.ddy]&quot;</span><span class="p">)</span>
</span><span id="__span-1-14"><a id="__codelineno-1-14" name="__codelineno-1-14" href="#__codelineno-1-14"></a>
</span><span id="__span-1-15"><a id="__codelineno-1-15" name="__codelineno-1-15" href="#__codelineno-1-15"></a>
</span><span id="__span-1-16"><a id="__codelineno-1-16" name="__codelineno-1-16" href="#__codelineno-1-16"></a><span class="k">class</span><span class="w"> </span><span class="nc">BuildingSimulationOutput</span><span class="p">(</span><span class="n">ExperimentOutputSpec</span><span class="p">):</span>
</span><span id="__span-1-17"><a id="__codelineno-1-17" name="__codelineno-1-17" href="#__codelineno-1-17"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Simulation outputs for a building energy model.&quot;&quot;&quot;</span>
</span><span id="__span-1-18"><a id="__codelineno-1-18" name="__codelineno-1-18" href="#__codelineno-1-18"></a>
</span><span id="__span-1-19"><a id="__codelineno-1-19" name="__codelineno-1-19" href="#__codelineno-1-19"></a>    <span class="n">heating</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">default</span><span class="o">=...</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Annual heating energy usage, kWh/m2&quot;</span><span class="p">,</span> <span class="n">ge</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</span><span id="__span-1-20"><a id="__codelineno-1-20" name="__codelineno-1-20" href="#__codelineno-1-20"></a>    <span class="n">cooling</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">default</span><span class="o">=...</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Annual cooling energy usage, kWh/m2&quot;</span><span class="p">,</span> <span class="n">ge</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</span><span id="__span-1-21"><a id="__codelineno-1-21" name="__codelineno-1-21" href="#__codelineno-1-21"></a>    <span class="n">lighting</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">default</span><span class="o">=...</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Annual lighting energy usage, kWh/m2&quot;</span><span class="p">,</span> <span class="n">ge</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</span><span id="__span-1-22"><a id="__codelineno-1-22" name="__codelineno-1-22" href="#__codelineno-1-22"></a>    <span class="n">equipment</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">default</span><span class="o">=...</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Annual equipment energy usage, kWh/m2&quot;</span><span class="p">,</span> <span class="n">ge</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</span><span id="__span-1-23"><a id="__codelineno-1-23" name="__codelineno-1-23" href="#__codelineno-1-23"></a>    <span class="n">fans</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">default</span><span class="o">=...</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Annual fans energy usage, kWh/m2&quot;</span><span class="p">,</span> <span class="n">ge</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</span><span id="__span-1-24"><a id="__codelineno-1-24" name="__codelineno-1-24" href="#__codelineno-1-24"></a>    <span class="n">pumps</span><span class="p">:</span> <span class="nb">float</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">default</span><span class="o">=...</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Annual pumps energy usage, kWh/m2&quot;</span><span class="p">,</span> <span class="n">ge</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</span><span id="__span-1-25"><a id="__codelineno-1-25" name="__codelineno-1-25" href="#__codelineno-1-25"></a>    <span class="n">timeseries</span><span class="p">:</span> <span class="n">FileReference</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="n">default</span><span class="o">=...</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;High-res Timeseries data.&quot;</span><span class="p">)</span> <span class="c1"># (2)!</span>
</span></code></pre></div>
<ol>
<li>When the experiment is allocated, if <code>weather_file</code> or <code>design_day_file</code> are <code>pathlib.Path</code> objects (as opposed to <code>S3Url</code> or <code>HttpUrl</code>), they will be automatically uploaded to S3 and re-referenced.</li>
<li>If <code>timeseries</code> is a <code>pathlib.Path</code> object (as opposed to <code>S3Url</code> or <code>HttpUrl</code>), it will be automatically uploaded to S3 and re-referenced.</li>
</ol>
<p>The schemas above will be exported into your results bucket as <code>experiment_io_spec.yaml</code>
including any docstrings and descriptions, following <a href="https://docs.pydantic.dev/latest/concepts/json_schema/">JSON Schema</a>.</p>
<p><em>nb: you can also add your own dataframes to the outputs, e.g. for non-scalar values
like timeseries and so on. documentation coming soon.</em></p>
<p>Next, we define the actual simulation logic. We will decorate the simulation function
with an indicator that it should be a part of our <code>ExperimentRegistry</code>, which configures
all of the fancy scatter/gather logic. Note that the function can only take a single
argument (the schema defined previously) and can only return a single output instance of
the previously defined output schema (though additional dataframes can be stored in the
<code>dataframes</code> field inherited from the base <code>ExperimentOutputSpec</code>.).</p>
<div class="language-py highlight"><span class="filename">experiments/building_energy.py</span><pre><span></span><code><span id="__span-2-1"><a id="__codelineno-2-1" name="__codelineno-2-1" href="#__codelineno-2-1"></a><span class="kn">from</span><span class="w"> </span><span class="nn">scythe.registry</span><span class="w"> </span><span class="kn">import</span> <span class="n">ExperimentRegistry</span>
</span><span id="__span-2-2"><a id="__codelineno-2-2" name="__codelineno-2-2" href="#__codelineno-2-2"></a>
</span><span id="__span-2-3"><a id="__codelineno-2-3" name="__codelineno-2-3" href="#__codelineno-2-3"></a><span class="nd">@ExperimentRegistry</span><span class="o">.</span><span class="n">Register</span><span class="p">()</span>
</span><span id="__span-2-4"><a id="__codelineno-2-4" name="__codelineno-2-4" href="#__codelineno-2-4"></a><span class="k">def</span><span class="w"> </span><span class="nf">simulate_energy</span><span class="p">(</span><span class="n">input_spec</span><span class="p">:</span> <span class="n">BuildingSimulationInput</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">BuildingSimulationOutput</span><span class="p">:</span>
</span><span id="__span-2-5"><a id="__codelineno-2-5" name="__codelineno-2-5" href="#__codelineno-2-5"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Initialize and execute an energy model of a building.&quot;&quot;&quot;</span>
</span><span id="__span-2-6"><a id="__codelineno-2-6" name="__codelineno-2-6" href="#__codelineno-2-6"></a>
</span><span id="__span-2-7"><a id="__codelineno-2-7" name="__codelineno-2-7" href="#__codelineno-2-7"></a>    <span class="c1"># do some work!</span>
</span><span id="__span-2-8"><a id="__codelineno-2-8" name="__codelineno-2-8" href="#__codelineno-2-8"></a>    <span class="o">...</span>
</span><span id="__span-2-9"><a id="__codelineno-2-9" name="__codelineno-2-9" href="#__codelineno-2-9"></a>
</span><span id="__span-2-10"><a id="__codelineno-2-10" name="__codelineno-2-10" href="#__codelineno-2-10"></a>    <span class="k">return</span> <span class="n">BuildingSimulationOutput</span><span class="p">(</span>
</span><span id="__span-2-11"><a id="__codelineno-2-11" name="__codelineno-2-11" href="#__codelineno-2-11"></a>        <span class="n">heating</span><span class="o">=...</span><span class="p">,</span>
</span><span id="__span-2-12"><a id="__codelineno-2-12" name="__codelineno-2-12" href="#__codelineno-2-12"></a>        <span class="n">cooling</span><span class="o">=...</span><span class="p">,</span>
</span><span id="__span-2-13"><a id="__codelineno-2-13" name="__codelineno-2-13" href="#__codelineno-2-13"></a>        <span class="n">lighting</span><span class="o">=...</span><span class="p">,</span>
</span><span id="__span-2-14"><a id="__codelineno-2-14" name="__codelineno-2-14" href="#__codelineno-2-14"></a>        <span class="n">equipment</span><span class="o">=...</span><span class="p">,</span>
</span><span id="__span-2-15"><a id="__codelineno-2-15" name="__codelineno-2-15" href="#__codelineno-2-15"></a>        <span class="n">fans</span><span class="o">=...</span><span class="p">,</span>
</span><span id="__span-2-16"><a id="__codelineno-2-16" name="__codelineno-2-16" href="#__codelineno-2-16"></a>        <span class="n">pumps</span><span class="o">=...</span>
</span><span id="__span-2-17"><a id="__codelineno-2-17" name="__codelineno-2-17" href="#__codelineno-2-17"></a>        <span class="n">timeseries</span><span class="o">=...</span><span class="p">,</span>
</span><span id="__span-2-18"><a id="__codelineno-2-18" name="__codelineno-2-18" href="#__codelineno-2-18"></a>        <span class="n">dataframes</span><span class="o">=...</span><span class="p">,</span>
</span><span id="__span-2-19"><a id="__codelineno-2-19" name="__codelineno-2-19" href="#__codelineno-2-19"></a>    <span class="p">)</span>
</span></code></pre></div>
<p>Since <code>BuildingSimulationInput</code> inherited from <code>ExperimentInputSpec</code>, some methods
automatically exist on the class, e.g. <code>log</code> for writing messages to the worker logs, or
methods for fetching common artifact files from remote resources like S3 or a web request
into a cacheable filesystem.</p>
<p>You can also define your simulation function with an additional <code>tempdir: Path</code> argument, which will be
an automatically created temporary directory (individualized for each task run)
that gets passed in which you can use to e.g. write output files or otherwise use as a
working directory which gets automatically cleaned up when the task finishes:</p>
<div class="language-py highlight"><span class="filename">experiments/building_energy.py</span><pre><span></span><code><span id="__span-3-1"><a id="__codelineno-3-1" name="__codelineno-3-1" href="#__codelineno-3-1"></a><span class="kn">from</span><span class="w"> </span><span class="nn">pathlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">Path</span>
</span><span id="__span-3-2"><a id="__codelineno-3-2" name="__codelineno-3-2" href="#__codelineno-3-2"></a>
</span><span id="__span-3-3"><a id="__codelineno-3-3" name="__codelineno-3-3" href="#__codelineno-3-3"></a><span class="nd">@ExperimentRegistry</span><span class="o">.</span><span class="n">Register</span><span class="p">()</span>
</span><span id="__span-3-4"><a id="__codelineno-3-4" name="__codelineno-3-4" href="#__codelineno-3-4"></a><span class="k">def</span><span class="w"> </span><span class="nf">simulate_energy</span><span class="p">(</span><span class="n">input_spec</span><span class="p">:</span> <span class="n">BuildingSimulationInput</span><span class="p">,</span> <span class="n">tempdir</span><span class="p">:</span> <span class="n">Path</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">BuildingSimulationOutput</span><span class="p">:</span>
</span><span id="__span-3-5"><a id="__codelineno-3-5" name="__codelineno-3-5" href="#__codelineno-3-5"></a>    <span class="o">...</span>
</span><span id="__span-3-6"><a id="__codelineno-3-6" name="__codelineno-3-6" href="#__codelineno-3-6"></a>    <span class="n">timeseries_fpath</span> <span class="o">=</span> <span class="n">tempdir</span> <span class="o">/</span> <span class="s2">&quot;timeseries.pq&quot;</span>
</span><span id="__span-3-7"><a id="__codelineno-3-7" name="__codelineno-3-7" href="#__codelineno-3-7"></a>    <span class="n">timeseries</span><span class="o">.</span><span class="n">to_parquet</span><span class="p">(</span><span class="n">timeseries_fpath</span><span class="p">)</span>
</span><span id="__span-3-8"><a id="__codelineno-3-8" name="__codelineno-3-8" href="#__codelineno-3-8"></a>
</span><span id="__span-3-9"><a id="__codelineno-3-9" name="__codelineno-3-9" href="#__codelineno-3-9"></a>    <span class="k">return</span> <span class="n">BuildingSimulationOutput</span><span class="p">(</span>
</span><span id="__span-3-10"><a id="__codelineno-3-10" name="__codelineno-3-10" href="#__codelineno-3-10"></a>        <span class="o">...</span>
</span><span id="__span-3-11"><a id="__codelineno-3-11" name="__codelineno-3-11" href="#__codelineno-3-11"></a>        <span class="n">timeseries</span><span class="o">=</span><span class="n">timeseries_fpath</span> <span class="c1"># (1)!</span>
</span><span id="__span-3-12"><a id="__codelineno-3-12" name="__codelineno-3-12" href="#__codelineno-3-12"></a>    <span class="p">)</span>
</span></code></pre></div>
<ol>
<li>This file (and any other fields which are <code>FileReference-&gt;pathlib.Path</code>) will automatically get uploaded to S3 and re-referenced, and
   an output dataframe at the experiment level will be generated which stores a list of all referenced files across all simulations (e.g. for use in a dataloader).</li>
</ol>
<p>This is particularly useful when you might be writing out large files for every individual
simulation which you do not want to combine into a single large results file across all task
runs (e.g. with many channels high-resolution timeseries data or images) and which you would prefer
to load in the future from the effective data warehouse that each experiment creates. Scythe
will automatically transfer these from the local file system to the S3 bucket when
the experiment task run finishes and store references to the outputs in a single dataframe for all the individual simulation runs for easy use in e.g. a dataloader.</p>
<p><strong><em>TODO: document artifact fetching</em></strong></p>
<p>In order to run your parallel experiments, you will need to generate a population of samples
from your design space. For now, we'll assume that you've done this with something like
numpy, pandas, or your favorite design-of-experiments lib. It might look something like this.</p>
<div class="language-py highlight"><span class="filename">sample.py</span><pre><span></span><code><span id="__span-4-1"><a id="__codelineno-4-1" name="__codelineno-4-1" href="#__codelineno-4-1"></a><span class="kn">from</span><span class="w"> </span><span class="nn">pathlib</span><span class="w"> </span><span class="kn">import</span> <span class="n">Path</span>
</span><span id="__span-4-2"><a id="__codelineno-4-2" name="__codelineno-4-2" href="#__codelineno-4-2"></a>
</span><span id="__span-4-3"><a id="__codelineno-4-3" name="__codelineno-4-3" href="#__codelineno-4-3"></a><span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">np</span>
</span><span id="__span-4-4"><a id="__codelineno-4-4" name="__codelineno-4-4" href="#__codelineno-4-4"></a><span class="kn">import</span><span class="w"> </span><span class="nn">pandas</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">pd</span>
</span><span id="__span-4-5"><a id="__codelineno-4-5" name="__codelineno-4-5" href="#__codelineno-4-5"></a>
</span><span id="__span-4-6"><a id="__codelineno-4-6" name="__codelineno-4-6" href="#__codelineno-4-6"></a><span class="kn">from</span><span class="w"> </span><span class="nn">experiments.building_energy</span><span class="w"> </span><span class="kn">import</span> <span class="n">BuildingSimulationInput</span>
</span><span id="__span-4-7"><a id="__codelineno-4-7" name="__codelineno-4-7" href="#__codelineno-4-7"></a>
</span><span id="__span-4-8"><a id="__codelineno-4-8" name="__codelineno-4-8" href="#__codelineno-4-8"></a><span class="k">def</span><span class="w"> </span><span class="nf">sample</span><span class="p">(</span><span class="n">n</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">100</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="n">BuildingSimulationInput</span><span class="p">]:</span>
</span><span id="__span-4-9"><a id="__codelineno-4-9" name="__codelineno-4-9" href="#__codelineno-4-9"></a>    <span class="n">r_value</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">15</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">n</span><span class="p">)</span>
</span><span id="__span-4-10"><a id="__codelineno-4-10" name="__codelineno-4-10" href="#__codelineno-4-10"></a>    <span class="n">lpd</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">n</span><span class="p">)</span>
</span><span id="__span-4-11"><a id="__codelineno-4-11" name="__codelineno-4-11" href="#__codelineno-4-11"></a>    <span class="n">setpoint</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">uniform</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span> <span class="mi">30</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="n">n</span><span class="p">)</span>
</span><span id="__span-4-12"><a id="__codelineno-4-12" name="__codelineno-4-12" href="#__codelineno-4-12"></a>    <span class="n">economizer</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span>
</span><span id="__span-4-13"><a id="__codelineno-4-13" name="__codelineno-4-13" href="#__codelineno-4-13"></a>        <span class="p">[</span><span class="s2">&quot;NoEconomizer&quot;</span><span class="p">,</span> <span class="s2">&quot;DifferentialDryBulb&quot;</span><span class="p">,</span> <span class="s2">&quot;DifferentialEnthalpy&quot;</span><span class="p">],</span> <span class="n">size</span><span class="o">=</span><span class="n">n</span>
</span><span id="__span-4-14"><a id="__codelineno-4-14" name="__codelineno-4-14" href="#__codelineno-4-14"></a>    <span class="p">)</span>
</span><span id="__span-4-15"><a id="__codelineno-4-15" name="__codelineno-4-15" href="#__codelineno-4-15"></a>    <span class="n">weather_file</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="__span-4-16"><a id="__codelineno-4-16" name="__codelineno-4-16" href="#__codelineno-4-16"></a>        <span class="n">Path</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
</span><span id="__span-4-17"><a id="__codelineno-4-17" name="__codelineno-4-17" href="#__codelineno-4-17"></a>        <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span>
</span><span id="__span-4-18"><a id="__codelineno-4-18" name="__codelineno-4-18" href="#__codelineno-4-18"></a>            <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">Path</span><span class="p">(</span><span class="s2">&quot;artifacts&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s2">&quot;*.epw&quot;</span><span class="p">)],</span> <span class="n">size</span><span class="o">=</span><span class="n">n</span>
</span><span id="__span-4-19"><a id="__codelineno-4-19" name="__codelineno-4-19" href="#__codelineno-4-19"></a>        <span class="p">)</span>
</span><span id="__span-4-20"><a id="__codelineno-4-20" name="__codelineno-4-20" href="#__codelineno-4-20"></a>    <span class="p">]</span>
</span><span id="__span-4-21"><a id="__codelineno-4-21" name="__codelineno-4-21" href="#__codelineno-4-21"></a>    <span class="n">design_day_file</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;artifacts/</span><span class="si">{</span><span class="n">Path</span><span class="p">(</span><span class="n">name</span><span class="p">)</span><span class="o">.</span><span class="n">stem</span><span class="si">}</span><span class="s2">.ddy&quot;</span> <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">weather_file</span><span class="p">]</span>
</span><span id="__span-4-22"><a id="__codelineno-4-22" name="__codelineno-4-22" href="#__codelineno-4-22"></a>    <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span> <span class="c1"># (1)!</span>
</span><span id="__span-4-23"><a id="__codelineno-4-23" name="__codelineno-4-23" href="#__codelineno-4-23"></a>        <span class="p">{</span>
</span><span id="__span-4-24"><a id="__codelineno-4-24" name="__codelineno-4-24" href="#__codelineno-4-24"></a>            <span class="s2">&quot;r_value&quot;</span><span class="p">:</span> <span class="n">r_value</span><span class="p">,</span>
</span><span id="__span-4-25"><a id="__codelineno-4-25" name="__codelineno-4-25" href="#__codelineno-4-25"></a>            <span class="s2">&quot;lpd&quot;</span><span class="p">:</span> <span class="n">lpd</span><span class="p">,</span>
</span><span id="__span-4-26"><a id="__codelineno-4-26" name="__codelineno-4-26" href="#__codelineno-4-26"></a>            <span class="s2">&quot;setpoint&quot;</span><span class="p">:</span> <span class="n">setpoint</span><span class="p">,</span>
</span><span id="__span-4-27"><a id="__codelineno-4-27" name="__codelineno-4-27" href="#__codelineno-4-27"></a>            <span class="s2">&quot;economizer&quot;</span><span class="p">:</span> <span class="n">economizer</span><span class="p">,</span>
</span><span id="__span-4-28"><a id="__codelineno-4-28" name="__codelineno-4-28" href="#__codelineno-4-28"></a>            <span class="s2">&quot;weather_file&quot;</span><span class="p">:</span> <span class="n">weather_file</span><span class="p">,</span>
</span><span id="__span-4-29"><a id="__codelineno-4-29" name="__codelineno-4-29" href="#__codelineno-4-29"></a>            <span class="s2">&quot;design_day_file&quot;</span><span class="p">:</span> <span class="n">design_day_file</span><span class="p">,</span>
</span><span id="__span-4-30"><a id="__codelineno-4-30" name="__codelineno-4-30" href="#__codelineno-4-30"></a>            <span class="s2">&quot;experiment_id&quot;</span><span class="p">:</span> <span class="s2">&quot;placeholder&quot;</span><span class="p">,</span> <span class="c1"># (2)!</span>
</span><span id="__span-4-31"><a id="__codelineno-4-31" name="__codelineno-4-31" href="#__codelineno-4-31"></a>            <span class="s2">&quot;sort_index&quot;</span><span class="p">:</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">n</span><span class="p">)),</span>
</span><span id="__span-4-32"><a id="__codelineno-4-32" name="__codelineno-4-32" href="#__codelineno-4-32"></a>        <span class="p">}</span>
</span><span id="__span-4-33"><a id="__codelineno-4-33" name="__codelineno-4-33" href="#__codelineno-4-33"></a>    <span class="p">)</span>
</span><span id="__span-4-34"><a id="__codelineno-4-34" name="__codelineno-4-34" href="#__codelineno-4-34"></a>    <span class="n">specs</span> <span class="o">=</span> <span class="p">[</span>
</span><span id="__span-4-35"><a id="__codelineno-4-35" name="__codelineno-4-35" href="#__codelineno-4-35"></a>        <span class="n">BuildingSimulationInput</span><span class="o">.</span><span class="n">model_validate</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">to_dict</span><span class="p">())</span>
</span><span id="__span-4-36"><a id="__codelineno-4-36" name="__codelineno-4-36" href="#__codelineno-4-36"></a>        <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">df</span><span class="o">.</span><span class="n">iterrows</span><span class="p">()</span>
</span><span id="__span-4-37"><a id="__codelineno-4-37" name="__codelineno-4-37" href="#__codelineno-4-37"></a>    <span class="p">]</span>
</span><span id="__span-4-38"><a id="__codelineno-4-38" name="__codelineno-4-38" href="#__codelineno-4-38"></a>    <span class="k">return</span> <span class="n">specs</span>
</span></code></pre></div>
<ol>
<li>I like to create a data frame and then convert to models, but it does not matter so much either way. You could directly create the models first if preferred.</li>
<li>This placeholder will get overwritten when we allocate the experiment by default with a fully resolved identifier.</li>
</ol>
<p>Now, we are finally ready to run our experiment! We will create an <code>BaseExperiment</code> object
in order to specify the versioning information for the experiment run we are about to initiate
via its <code>allocate</code> command, which will handle setting up the directory in our bucket,
serializing payloads, automatically transferring input artifacts to S3, and more. By
default, the experiment name used in S3 will be the name of the simulation task, and the
version will be autoresolved based off of previous runs in the bucket via <code>bumpmajor</code>,
<code>bumpminor</code>, <code>bumppatch</code> or <code>keep</code> - regardless of which is selected each run will still
be scoped by the initiation time, so even when using <code>keep</code>, you can have multiple experiment runs
for the same version. You can also pass in a version manually as a <code>scythe.experiments.SemVer</code>.</p>
<div class="language-py highlight"><span class="filename">allocate.py</span><pre><span></span><code><span id="__span-5-1"><a id="__codelineno-5-1" name="__codelineno-5-1" href="#__codelineno-5-1"></a><span class="kn">from</span><span class="w"> </span><span class="nn">scythe.experiments</span><span class="w"> </span><span class="kn">import</span> <span class="n">BaseExperiment</span>
</span><span id="__span-5-2"><a id="__codelineno-5-2" name="__codelineno-5-2" href="#__codelineno-5-2"></a>
</span><span id="__span-5-3"><a id="__codelineno-5-3" name="__codelineno-5-3" href="#__codelineno-5-3"></a><span class="kn">from</span><span class="w"> </span><span class="nn">experiments.building_energy</span><span class="w"> </span><span class="kn">import</span> <span class="n">simulate_energy</span>
</span><span id="__span-5-4"><a id="__codelineno-5-4" name="__codelineno-5-4" href="#__codelineno-5-4"></a><span class="kn">from</span><span class="w"> </span><span class="nn">sample</span><span class="w"> </span><span class="kn">import</span> <span class="n">sample</span>
</span><span id="__span-5-5"><a id="__codelineno-5-5" name="__codelineno-5-5" href="#__codelineno-5-5"></a>
</span><span id="__span-5-6"><a id="__codelineno-5-6" name="__codelineno-5-6" href="#__codelineno-5-6"></a><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
</span><span id="__span-5-7"><a id="__codelineno-5-7" name="__codelineno-5-7" href="#__codelineno-5-7"></a>
</span><span id="__span-5-8"><a id="__codelineno-5-8" name="__codelineno-5-8" href="#__codelineno-5-8"></a>    <span class="n">experiment</span> <span class="o">=</span> <span class="n">BaseExperiment</span><span class="p">(</span>
</span><span id="__span-5-9"><a id="__codelineno-5-9" name="__codelineno-5-9" href="#__codelineno-5-9"></a>        <span class="n">experiment</span><span class="o">=</span><span class="n">simulate_energy</span>
</span><span id="__span-5-10"><a id="__codelineno-5-10" name="__codelineno-5-10" href="#__codelineno-5-10"></a>
</span><span id="__span-5-11"><a id="__codelineno-5-11" name="__codelineno-5-11" href="#__codelineno-5-11"></a>    <span class="p">)</span>
</span><span id="__span-5-12"><a id="__codelineno-5-12" name="__codelineno-5-12" href="#__codelineno-5-12"></a>    <span class="n">specs</span> <span class="o">=</span> <span class="n">sample</span><span class="p">(</span><span class="mi">10</span><span class="p">)</span>
</span><span id="__span-5-13"><a id="__codelineno-5-13" name="__codelineno-5-13" href="#__codelineno-5-13"></a>
</span><span id="__span-5-14"><a id="__codelineno-5-14" name="__codelineno-5-14" href="#__codelineno-5-14"></a>    <span class="n">run</span><span class="p">,</span> <span class="n">ref</span> <span class="o">=</span> <span class="n">experiment</span><span class="o">.</span><span class="n">allocate</span><span class="p">(</span>
</span><span id="__span-5-15"><a id="__codelineno-5-15" name="__codelineno-5-15" href="#__codelineno-5-15"></a>        <span class="n">specs</span><span class="p">,</span>
</span><span id="__span-5-16"><a id="__codelineno-5-16" name="__codelineno-5-16" href="#__codelineno-5-16"></a>        <span class="n">version</span><span class="o">=</span><span class="s2">&quot;bumpminor&quot;</span><span class="p">,</span> <span class="c1"># (1)!</span>
</span><span id="__span-5-17"><a id="__codelineno-5-17" name="__codelineno-5-17" href="#__codelineno-5-17"></a>    <span class="p">)</span>
</span></code></pre></div>
<ol>
<li>This will auto-resolve the most recent experiment run of the same name in the bucket
   and increment the version, e.g. <code>v1.2.3</code> with <code>bumpminor</code> will transition to <code>v.1.3.0</code>.</li>
</ol>
<p>The <code>run</code> object is a <code>scythe.allocate.ExperimentRun</code> while the <code>ref</code> is a
<code>hatchet_sdk.runnables.workflow.TaskRunRef</code>. You can wait for the result to finish with
either <code>ref.result()</code> (blocking) or <code>await ref.aio_result()</code> (async). The final task result
will contain the URIs of any aggregated dataframes written to the buket.</p>
<p>After the experiment is finished running all tasks, it will automatically produce an output file <code>scalars.pq</code> with all of the results defined on your output schema for each of the individual simulations that were executed.</p>
<p>The index of the dataframe will itself be a dataframe with the input specs and some additional metadata, e.g:</p>
<p><code>MultiIndex</code></p>
<table>
<thead>
<tr>
<th>experiment_id</th>
<th>sort_index</th>
<th>root_workflow_run_id</th>
<th style="text-align: right;">r_value</th>
<th style="text-align: right;">lpd</th>
<th style="text-align: right;">setpoint</th>
</tr>
</thead>
<tbody>
<tr>
<td>bem/v1</td>
<td>0</td>
<td>abcd-efgh</td>
<td style="text-align: right;">5.2</td>
<td style="text-align: right;">2.7</td>
<td style="text-align: right;">23.5</td>
</tr>
<tr>
<td>bem/v1</td>
<td>1</td>
<td>abcd-efgh</td>
<td style="text-align: right;">2.9</td>
<td style="text-align: right;">1.3</td>
<td style="text-align: right;">19.7</td>
</tr>
<tr>
<td>bem/v1</td>
<td>2</td>
<td>abcd-efgh</td>
<td style="text-align: right;">4.2</td>
<td style="text-align: right;">5.4</td>
<td style="text-align: right;">21.4</td>
</tr>
</tbody>
</table>
<p><code>Data</code></p>
<table>
<thead>
<tr>
<th style="text-align: right;">heating</th>
<th style="text-align: right;">cooling</th>
<th style="text-align: right;">lighting</th>
<th style="text-align: right;">equipment</th>
<th style="text-align: right;">fans</th>
<th style="text-align: right;">pumps</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align: right;">17.2</td>
<td style="text-align: right;">15.3</td>
<td style="text-align: right;">10.1</td>
<td style="text-align: right;">13.8</td>
<td style="text-align: right;">14.2</td>
<td style="text-align: right;">1.4</td>
</tr>
<tr>
<td style="text-align: right;">21.7</td>
<td style="text-align: right;">5.4</td>
<td style="text-align: right;">9.2</td>
<td style="text-align: right;">5.8</td>
<td style="text-align: right;">10.3</td>
<td style="text-align: right;">2.0</td>
</tr>
<tr>
<td style="text-align: right;">19.5</td>
<td style="text-align: right;">8.9</td>
<td style="text-align: right;">12.5</td>
<td style="text-align: right;">13.7</td>
<td style="text-align: right;">8.9</td>
<td style="text-align: right;">0.9</td>
</tr>
</tbody>
</table>
<p>If any of the output fields were of type <code>FileReference</code>, there will be an additional parquet file written to the bucket called <code>result_file_refs.pq</code> with the same MultiIndex as <code>scalars.pq</code> and whose columns are the names of the <code>FileReference</code> fields and whose values are the URIs of those references.</p>
<p><strong><em>TODO: document how additional dataframes of results are handled.</em></strong></p>
<p>Additionally, in your bucket, you will find a <code>manifest.yml</code> file as well as an <code>input_artifacts.yml</code> and <code>experiment_io_spec.yml</code>.</p>
<div class="language-yaml highlight"><span class="filename">manifest.yml</span><pre><span></span><code><span id="__span-6-1"><a id="__codelineno-6-1" name="__codelineno-6-1" href="#__codelineno-6-1"></a><span class="nt">experiment_id</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">building_energy/v1.0.0/2025-07-23_12-59-51</span>
</span><span id="__span-6-2"><a id="__codelineno-6-2" name="__codelineno-6-2" href="#__codelineno-6-2"></a><span class="nt">experiment_name</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">scythe_experiment_simulate_energy</span>
</span><span id="__span-6-3"><a id="__codelineno-6-3" name="__codelineno-6-3" href="#__codelineno-6-3"></a><span class="nt">input_artifacts</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">s3://mit-sdl/scythe/building_energy/v1.0.0/2025-07-23_12-59-51/input_artifacts.yml</span>
</span><span id="__span-6-4"><a id="__codelineno-6-4" name="__codelineno-6-4" href="#__codelineno-6-4"></a><span class="nt">io_spec</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">s3://mit-sdl/scythe/building_energy/v1.0.0/2025-07-23_12-59-51/experiment_io_spec.yml</span>
</span><span id="__span-6-5"><a id="__codelineno-6-5" name="__codelineno-6-5" href="#__codelineno-6-5"></a><span class="nt">specs_uri</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">s3://mit-sdl/scythe/building_energy/v1.0.0/2025-07-23_12-59-51/specs.pq</span>
</span><span id="__span-6-6"><a id="__codelineno-6-6" name="__codelineno-6-6" href="#__codelineno-6-6"></a><span class="nt">workflow_run_id</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">f764ef33-a377-4572-a398-a2dc56a0810f</span>
</span></code></pre></div>
<div class="language-yaml highlight"><span class="filename">input_artifacts.yml</span><pre><span></span><code><span id="__span-7-1"><a id="__codelineno-7-1" name="__codelineno-7-1" href="#__codelineno-7-1"></a><span class="nt">files</span><span class="p">:</span>
</span><span id="__span-7-2"><a id="__codelineno-7-2" name="__codelineno-7-2" href="#__codelineno-7-2"></a><span class="w">  </span><span class="nt">design_day_file</span><span class="p">:</span>
</span><span id="__span-7-3"><a id="__codelineno-7-3" name="__codelineno-7-3" href="#__codelineno-7-3"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">s3://mit-sdl/scythe/building_energy/v1.0.0/2025-07-23_12-59-51/artifacts/design_day_file/USA_MA_Boston.Logan_TMYx.ddy</span>
</span><span id="__span-7-4"><a id="__codelineno-7-4" name="__codelineno-7-4" href="#__codelineno-7-4"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">s3://mit-sdl/scythe/building_energy/v1.0.0/2025-07-23_12-59-51/artifacts/design_day_file/USA_CA_Los.Angeles.LAX_TMYx.ddy</span>
</span><span id="__span-7-5"><a id="__codelineno-7-5" name="__codelineno-7-5" href="#__codelineno-7-5"></a><span class="w">  </span><span class="nt">weather_file</span><span class="p">:</span>
</span><span id="__span-7-6"><a id="__codelineno-7-6" name="__codelineno-7-6" href="#__codelineno-7-6"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">s3://mit-sdl/scythe/building_energy/v1.0.0/2025-07-23_12-59-51/artifacts/weather_file/USA_MA_Boston.Logan_TMYx.epw</span>
</span><span id="__span-7-7"><a id="__codelineno-7-7" name="__codelineno-7-7" href="#__codelineno-7-7"></a><span class="w">    </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">s3://mit-sdl/scythe/building_energy/v1.0.0/2025-07-23_12-59-51/artifacts/weather_file/USA_CA_Los.Angeles.LAX_TMYx.epw</span>
</span></code></pre></div>
<div class="language-yaml highlight"><span class="filename">experiment_io_spec.yml</span><pre><span></span><code><span id="__span-8-1"><a id="__codelineno-8-1" name="__codelineno-8-1" href="#__codelineno-8-1"></a><span class="nt">$defs</span><span class="p">:</span>
</span><span id="__span-8-2"><a id="__codelineno-8-2" name="__codelineno-8-2" href="#__codelineno-8-2"></a><span class="w">  </span><span class="nt">BuildingSimulationInput</span><span class="p">:</span>
</span><span id="__span-8-3"><a id="__codelineno-8-3" name="__codelineno-8-3" href="#__codelineno-8-3"></a><span class="w">    </span><span class="nt">additionalProperties</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">true</span>
</span><span id="__span-8-4"><a id="__codelineno-8-4" name="__codelineno-8-4" href="#__codelineno-8-4"></a><span class="w">    </span><span class="nt">description</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Simulation inputs for a building energy model.</span>
</span><span id="__span-8-5"><a id="__codelineno-8-5" name="__codelineno-8-5" href="#__codelineno-8-5"></a><span class="w">    </span><span class="nt">properties</span><span class="p">:</span>
</span><span id="__span-8-6"><a id="__codelineno-8-6" name="__codelineno-8-6" href="#__codelineno-8-6"></a><span class="w">      </span><span class="nt">design_day_file</span><span class="p">:</span>
</span><span id="__span-8-7"><a id="__codelineno-8-7" name="__codelineno-8-7" href="#__codelineno-8-7"></a><span class="w">        </span><span class="nt">anyOf</span><span class="p">:</span>
</span><span id="__span-8-8"><a id="__codelineno-8-8" name="__codelineno-8-8" href="#__codelineno-8-8"></a><span class="w">          </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">format</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">uri</span>
</span><span id="__span-8-9"><a id="__codelineno-8-9" name="__codelineno-8-9" href="#__codelineno-8-9"></a><span class="w">            </span><span class="nt">minLength</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">1</span>
</span><span id="__span-8-10"><a id="__codelineno-8-10" name="__codelineno-8-10" href="#__codelineno-8-10"></a><span class="w">            </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">string</span>
</span><span id="__span-8-11"><a id="__codelineno-8-11" name="__codelineno-8-11" href="#__codelineno-8-11"></a><span class="w">          </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">format</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">uri</span>
</span><span id="__span-8-12"><a id="__codelineno-8-12" name="__codelineno-8-12" href="#__codelineno-8-12"></a><span class="w">            </span><span class="nt">maxLength</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">2083</span>
</span><span id="__span-8-13"><a id="__codelineno-8-13" name="__codelineno-8-13" href="#__codelineno-8-13"></a><span class="w">            </span><span class="nt">minLength</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">1</span>
</span><span id="__span-8-14"><a id="__codelineno-8-14" name="__codelineno-8-14" href="#__codelineno-8-14"></a><span class="w">            </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">string</span>
</span><span id="__span-8-15"><a id="__codelineno-8-15" name="__codelineno-8-15" href="#__codelineno-8-15"></a><span class="w">          </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">format</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">path</span>
</span><span id="__span-8-16"><a id="__codelineno-8-16" name="__codelineno-8-16" href="#__codelineno-8-16"></a><span class="w">            </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">string</span>
</span><span id="__span-8-17"><a id="__codelineno-8-17" name="__codelineno-8-17" href="#__codelineno-8-17"></a><span class="w">          </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">format</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">file-path</span>
</span><span id="__span-8-18"><a id="__codelineno-8-18" name="__codelineno-8-18" href="#__codelineno-8-18"></a><span class="w">            </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">string</span>
</span><span id="__span-8-19"><a id="__codelineno-8-19" name="__codelineno-8-19" href="#__codelineno-8-19"></a><span class="w">        </span><span class="nt">description</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Weather file [.ddy]</span>
</span><span id="__span-8-20"><a id="__codelineno-8-20" name="__codelineno-8-20" href="#__codelineno-8-20"></a><span class="w">        </span><span class="nt">title</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Design Day File</span>
</span><span id="__span-8-21"><a id="__codelineno-8-21" name="__codelineno-8-21" href="#__codelineno-8-21"></a><span class="w">      </span><span class="nt">economizer</span><span class="p">:</span>
</span><span id="__span-8-22"><a id="__codelineno-8-22" name="__codelineno-8-22" href="#__codelineno-8-22"></a><span class="w">        </span><span class="nt">description</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">The type of economizer to use</span>
</span><span id="__span-8-23"><a id="__codelineno-8-23" name="__codelineno-8-23" href="#__codelineno-8-23"></a><span class="w">        </span><span class="nt">enum</span><span class="p">:</span>
</span><span id="__span-8-24"><a id="__codelineno-8-24" name="__codelineno-8-24" href="#__codelineno-8-24"></a><span class="w">          </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">NoEconomizer</span>
</span><span id="__span-8-25"><a id="__codelineno-8-25" name="__codelineno-8-25" href="#__codelineno-8-25"></a><span class="w">          </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">DifferentialDryBulb</span>
</span><span id="__span-8-26"><a id="__codelineno-8-26" name="__codelineno-8-26" href="#__codelineno-8-26"></a><span class="w">          </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">DifferentialEnthalpy</span>
</span><span id="__span-8-27"><a id="__codelineno-8-27" name="__codelineno-8-27" href="#__codelineno-8-27"></a><span class="w">        </span><span class="nt">title</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Economizer</span>
</span><span id="__span-8-28"><a id="__codelineno-8-28" name="__codelineno-8-28" href="#__codelineno-8-28"></a><span class="w">        </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">string</span>
</span><span id="__span-8-29"><a id="__codelineno-8-29" name="__codelineno-8-29" href="#__codelineno-8-29"></a><span class="w">      </span><span class="nt">experiment_id</span><span class="p">:</span>
</span><span id="__span-8-30"><a id="__codelineno-8-30" name="__codelineno-8-30" href="#__codelineno-8-30"></a><span class="w">        </span><span class="nt">description</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">The experiment_id of the spec</span>
</span><span id="__span-8-31"><a id="__codelineno-8-31" name="__codelineno-8-31" href="#__codelineno-8-31"></a><span class="w">        </span><span class="nt">title</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Experiment Id</span>
</span><span id="__span-8-32"><a id="__codelineno-8-32" name="__codelineno-8-32" href="#__codelineno-8-32"></a><span class="w">        </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">string</span>
</span><span id="__span-8-33"><a id="__codelineno-8-33" name="__codelineno-8-33" href="#__codelineno-8-33"></a><span class="w">      </span><span class="nt">lpd</span><span class="p">:</span>
</span><span id="__span-8-34"><a id="__codelineno-8-34" name="__codelineno-8-34" href="#__codelineno-8-34"></a><span class="w">        </span><span class="nt">description</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Lighting power density [W/m2]</span>
</span><span id="__span-8-35"><a id="__codelineno-8-35" name="__codelineno-8-35" href="#__codelineno-8-35"></a><span class="w">        </span><span class="nt">maximum</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">20</span>
</span><span id="__span-8-36"><a id="__codelineno-8-36" name="__codelineno-8-36" href="#__codelineno-8-36"></a><span class="w">        </span><span class="nt">minimum</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">0</span>
</span><span id="__span-8-37"><a id="__codelineno-8-37" name="__codelineno-8-37" href="#__codelineno-8-37"></a><span class="w">        </span><span class="nt">title</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Lpd</span>
</span><span id="__span-8-38"><a id="__codelineno-8-38" name="__codelineno-8-38" href="#__codelineno-8-38"></a><span class="w">        </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">number</span>
</span><span id="__span-8-39"><a id="__codelineno-8-39" name="__codelineno-8-39" href="#__codelineno-8-39"></a><span class="w">      </span><span class="nt">r_value</span><span class="p">:</span>
</span><span id="__span-8-40"><a id="__codelineno-8-40" name="__codelineno-8-40" href="#__codelineno-8-40"></a><span class="w">        </span><span class="nt">description</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">The R-Value of the building [m2K/W]</span>
</span><span id="__span-8-41"><a id="__codelineno-8-41" name="__codelineno-8-41" href="#__codelineno-8-41"></a><span class="w">        </span><span class="nt">maximum</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">15</span>
</span><span id="__span-8-42"><a id="__codelineno-8-42" name="__codelineno-8-42" href="#__codelineno-8-42"></a><span class="w">        </span><span class="nt">minimum</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">0</span>
</span><span id="__span-8-43"><a id="__codelineno-8-43" name="__codelineno-8-43" href="#__codelineno-8-43"></a><span class="w">        </span><span class="nt">title</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">R Value</span>
</span><span id="__span-8-44"><a id="__codelineno-8-44" name="__codelineno-8-44" href="#__codelineno-8-44"></a><span class="w">        </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">number</span>
</span><span id="__span-8-45"><a id="__codelineno-8-45" name="__codelineno-8-45" href="#__codelineno-8-45"></a><span class="w">      </span><span class="nt">root_workflow_run_id</span><span class="p">:</span>
</span><span id="__span-8-46"><a id="__codelineno-8-46" name="__codelineno-8-46" href="#__codelineno-8-46"></a><span class="w">        </span><span class="nt">anyOf</span><span class="p">:</span>
</span><span id="__span-8-47"><a id="__codelineno-8-47" name="__codelineno-8-47" href="#__codelineno-8-47"></a><span class="w">          </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">string</span>
</span><span id="__span-8-48"><a id="__codelineno-8-48" name="__codelineno-8-48" href="#__codelineno-8-48"></a><span class="w">          </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;null&quot;</span>
</span><span id="__span-8-49"><a id="__codelineno-8-49" name="__codelineno-8-49" href="#__codelineno-8-49"></a><span class="w">        </span><span class="nt">default</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">null</span>
</span><span id="__span-8-50"><a id="__codelineno-8-50" name="__codelineno-8-50" href="#__codelineno-8-50"></a><span class="w">        </span><span class="nt">description</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">The root workflow run id of the leaf.</span>
</span><span id="__span-8-51"><a id="__codelineno-8-51" name="__codelineno-8-51" href="#__codelineno-8-51"></a><span class="w">        </span><span class="nt">title</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Root Workflow Run Id</span>
</span><span id="__span-8-52"><a id="__codelineno-8-52" name="__codelineno-8-52" href="#__codelineno-8-52"></a><span class="w">      </span><span class="nt">setpoint</span><span class="p">:</span>
</span><span id="__span-8-53"><a id="__codelineno-8-53" name="__codelineno-8-53" href="#__codelineno-8-53"></a><span class="w">        </span><span class="nt">description</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Thermostat setpoint [deg.C]</span>
</span><span id="__span-8-54"><a id="__codelineno-8-54" name="__codelineno-8-54" href="#__codelineno-8-54"></a><span class="w">        </span><span class="nt">maximum</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">30</span>
</span><span id="__span-8-55"><a id="__codelineno-8-55" name="__codelineno-8-55" href="#__codelineno-8-55"></a><span class="w">        </span><span class="nt">minimum</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">12</span>
</span><span id="__span-8-56"><a id="__codelineno-8-56" name="__codelineno-8-56" href="#__codelineno-8-56"></a><span class="w">        </span><span class="nt">title</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Setpoint</span>
</span><span id="__span-8-57"><a id="__codelineno-8-57" name="__codelineno-8-57" href="#__codelineno-8-57"></a><span class="w">        </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">number</span>
</span><span id="__span-8-58"><a id="__codelineno-8-58" name="__codelineno-8-58" href="#__codelineno-8-58"></a><span class="w">      </span><span class="nt">sort_index</span><span class="p">:</span>
</span><span id="__span-8-59"><a id="__codelineno-8-59" name="__codelineno-8-59" href="#__codelineno-8-59"></a><span class="w">        </span><span class="nt">description</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">The sort index of the leaf.</span>
</span><span id="__span-8-60"><a id="__codelineno-8-60" name="__codelineno-8-60" href="#__codelineno-8-60"></a><span class="w">        </span><span class="nt">minimum</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">0</span>
</span><span id="__span-8-61"><a id="__codelineno-8-61" name="__codelineno-8-61" href="#__codelineno-8-61"></a><span class="w">        </span><span class="nt">title</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Sort Index</span>
</span><span id="__span-8-62"><a id="__codelineno-8-62" name="__codelineno-8-62" href="#__codelineno-8-62"></a><span class="w">        </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">integer</span>
</span><span id="__span-8-63"><a id="__codelineno-8-63" name="__codelineno-8-63" href="#__codelineno-8-63"></a><span class="w">      </span><span class="nt">weather_file</span><span class="p">:</span>
</span><span id="__span-8-64"><a id="__codelineno-8-64" name="__codelineno-8-64" href="#__codelineno-8-64"></a><span class="w">        </span><span class="nt">anyOf</span><span class="p">:</span>
</span><span id="__span-8-65"><a id="__codelineno-8-65" name="__codelineno-8-65" href="#__codelineno-8-65"></a><span class="w">          </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">format</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">uri</span>
</span><span id="__span-8-66"><a id="__codelineno-8-66" name="__codelineno-8-66" href="#__codelineno-8-66"></a><span class="w">            </span><span class="nt">minLength</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">1</span>
</span><span id="__span-8-67"><a id="__codelineno-8-67" name="__codelineno-8-67" href="#__codelineno-8-67"></a><span class="w">            </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">string</span>
</span><span id="__span-8-68"><a id="__codelineno-8-68" name="__codelineno-8-68" href="#__codelineno-8-68"></a><span class="w">          </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">format</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">uri</span>
</span><span id="__span-8-69"><a id="__codelineno-8-69" name="__codelineno-8-69" href="#__codelineno-8-69"></a><span class="w">            </span><span class="nt">maxLength</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">2083</span>
</span><span id="__span-8-70"><a id="__codelineno-8-70" name="__codelineno-8-70" href="#__codelineno-8-70"></a><span class="w">            </span><span class="nt">minLength</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">1</span>
</span><span id="__span-8-71"><a id="__codelineno-8-71" name="__codelineno-8-71" href="#__codelineno-8-71"></a><span class="w">            </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">string</span>
</span><span id="__span-8-72"><a id="__codelineno-8-72" name="__codelineno-8-72" href="#__codelineno-8-72"></a><span class="w">          </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">format</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">path</span>
</span><span id="__span-8-73"><a id="__codelineno-8-73" name="__codelineno-8-73" href="#__codelineno-8-73"></a><span class="w">            </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">string</span>
</span><span id="__span-8-74"><a id="__codelineno-8-74" name="__codelineno-8-74" href="#__codelineno-8-74"></a><span class="w">          </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">format</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">file-path</span>
</span><span id="__span-8-75"><a id="__codelineno-8-75" name="__codelineno-8-75" href="#__codelineno-8-75"></a><span class="w">            </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">string</span>
</span><span id="__span-8-76"><a id="__codelineno-8-76" name="__codelineno-8-76" href="#__codelineno-8-76"></a><span class="w">        </span><span class="nt">description</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Weather file [.epw]</span>
</span><span id="__span-8-77"><a id="__codelineno-8-77" name="__codelineno-8-77" href="#__codelineno-8-77"></a><span class="w">        </span><span class="nt">title</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Weather File</span>
</span><span id="__span-8-78"><a id="__codelineno-8-78" name="__codelineno-8-78" href="#__codelineno-8-78"></a><span class="w">      </span><span class="nt">workflow_run_id</span><span class="p">:</span>
</span><span id="__span-8-79"><a id="__codelineno-8-79" name="__codelineno-8-79" href="#__codelineno-8-79"></a><span class="w">        </span><span class="nt">anyOf</span><span class="p">:</span>
</span><span id="__span-8-80"><a id="__codelineno-8-80" name="__codelineno-8-80" href="#__codelineno-8-80"></a><span class="w">          </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">string</span>
</span><span id="__span-8-81"><a id="__codelineno-8-81" name="__codelineno-8-81" href="#__codelineno-8-81"></a><span class="w">          </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;null&quot;</span>
</span><span id="__span-8-82"><a id="__codelineno-8-82" name="__codelineno-8-82" href="#__codelineno-8-82"></a><span class="w">        </span><span class="nt">default</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">null</span>
</span><span id="__span-8-83"><a id="__codelineno-8-83" name="__codelineno-8-83" href="#__codelineno-8-83"></a><span class="w">        </span><span class="nt">description</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">The workflow run id of the leaf.</span>
</span><span id="__span-8-84"><a id="__codelineno-8-84" name="__codelineno-8-84" href="#__codelineno-8-84"></a><span class="w">        </span><span class="nt">title</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Workflow Run Id</span>
</span><span id="__span-8-85"><a id="__codelineno-8-85" name="__codelineno-8-85" href="#__codelineno-8-85"></a><span class="w">    </span><span class="nt">required</span><span class="p">:</span>
</span><span id="__span-8-86"><a id="__codelineno-8-86" name="__codelineno-8-86" href="#__codelineno-8-86"></a><span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">experiment_id</span>
</span><span id="__span-8-87"><a id="__codelineno-8-87" name="__codelineno-8-87" href="#__codelineno-8-87"></a><span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">sort_index</span>
</span><span id="__span-8-88"><a id="__codelineno-8-88" name="__codelineno-8-88" href="#__codelineno-8-88"></a><span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">r_value</span>
</span><span id="__span-8-89"><a id="__codelineno-8-89" name="__codelineno-8-89" href="#__codelineno-8-89"></a><span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">lpd</span>
</span><span id="__span-8-90"><a id="__codelineno-8-90" name="__codelineno-8-90" href="#__codelineno-8-90"></a><span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">setpoint</span>
</span><span id="__span-8-91"><a id="__codelineno-8-91" name="__codelineno-8-91" href="#__codelineno-8-91"></a><span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">economizer</span>
</span><span id="__span-8-92"><a id="__codelineno-8-92" name="__codelineno-8-92" href="#__codelineno-8-92"></a><span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">weather_file</span>
</span><span id="__span-8-93"><a id="__codelineno-8-93" name="__codelineno-8-93" href="#__codelineno-8-93"></a><span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">design_day_file</span>
</span><span id="__span-8-94"><a id="__codelineno-8-94" name="__codelineno-8-94" href="#__codelineno-8-94"></a><span class="w">    </span><span class="nt">title</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">BuildingSimulationInput</span>
</span><span id="__span-8-95"><a id="__codelineno-8-95" name="__codelineno-8-95" href="#__codelineno-8-95"></a><span class="w">    </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">object</span>
</span><span id="__span-8-96"><a id="__codelineno-8-96" name="__codelineno-8-96" href="#__codelineno-8-96"></a><span class="w">  </span><span class="nt">BuildingSimulationOutput</span><span class="p">:</span>
</span><span id="__span-8-97"><a id="__codelineno-8-97" name="__codelineno-8-97" href="#__codelineno-8-97"></a><span class="w">    </span><span class="nt">description</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Simulation outputs for a building energy model.</span>
</span><span id="__span-8-98"><a id="__codelineno-8-98" name="__codelineno-8-98" href="#__codelineno-8-98"></a><span class="w">    </span><span class="nt">properties</span><span class="p">:</span>
</span><span id="__span-8-99"><a id="__codelineno-8-99" name="__codelineno-8-99" href="#__codelineno-8-99"></a><span class="w">      </span><span class="nt">cooling</span><span class="p">:</span>
</span><span id="__span-8-100"><a id="__codelineno-8-100" name="__codelineno-8-100" href="#__codelineno-8-100"></a><span class="w">        </span><span class="nt">description</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Annual cooling energy usage, kWh/m2</span>
</span><span id="__span-8-101"><a id="__codelineno-8-101" name="__codelineno-8-101" href="#__codelineno-8-101"></a><span class="w">        </span><span class="nt">minimum</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">0</span>
</span><span id="__span-8-102"><a id="__codelineno-8-102" name="__codelineno-8-102" href="#__codelineno-8-102"></a><span class="w">        </span><span class="nt">title</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Cooling</span>
</span><span id="__span-8-103"><a id="__codelineno-8-103" name="__codelineno-8-103" href="#__codelineno-8-103"></a><span class="w">        </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">number</span>
</span><span id="__span-8-104"><a id="__codelineno-8-104" name="__codelineno-8-104" href="#__codelineno-8-104"></a><span class="w">      </span><span class="nt">equipment</span><span class="p">:</span>
</span><span id="__span-8-105"><a id="__codelineno-8-105" name="__codelineno-8-105" href="#__codelineno-8-105"></a><span class="w">        </span><span class="nt">description</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Annual equipment energy usage, kWh/m2</span>
</span><span id="__span-8-106"><a id="__codelineno-8-106" name="__codelineno-8-106" href="#__codelineno-8-106"></a><span class="w">        </span><span class="nt">minimum</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">0</span>
</span><span id="__span-8-107"><a id="__codelineno-8-107" name="__codelineno-8-107" href="#__codelineno-8-107"></a><span class="w">        </span><span class="nt">title</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Equipment</span>
</span><span id="__span-8-108"><a id="__codelineno-8-108" name="__codelineno-8-108" href="#__codelineno-8-108"></a><span class="w">        </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">number</span>
</span><span id="__span-8-109"><a id="__codelineno-8-109" name="__codelineno-8-109" href="#__codelineno-8-109"></a><span class="w">      </span><span class="nt">fans</span><span class="p">:</span>
</span><span id="__span-8-110"><a id="__codelineno-8-110" name="__codelineno-8-110" href="#__codelineno-8-110"></a><span class="w">        </span><span class="nt">description</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Annual fans energy usage, kWh/m2</span>
</span><span id="__span-8-111"><a id="__codelineno-8-111" name="__codelineno-8-111" href="#__codelineno-8-111"></a><span class="w">        </span><span class="nt">minimum</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">0</span>
</span><span id="__span-8-112"><a id="__codelineno-8-112" name="__codelineno-8-112" href="#__codelineno-8-112"></a><span class="w">        </span><span class="nt">title</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Fans</span>
</span><span id="__span-8-113"><a id="__codelineno-8-113" name="__codelineno-8-113" href="#__codelineno-8-113"></a><span class="w">        </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">number</span>
</span><span id="__span-8-114"><a id="__codelineno-8-114" name="__codelineno-8-114" href="#__codelineno-8-114"></a><span class="w">      </span><span class="nt">heating</span><span class="p">:</span>
</span><span id="__span-8-115"><a id="__codelineno-8-115" name="__codelineno-8-115" href="#__codelineno-8-115"></a><span class="w">        </span><span class="nt">description</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Annual heating energy usage, kWh/m2</span>
</span><span id="__span-8-116"><a id="__codelineno-8-116" name="__codelineno-8-116" href="#__codelineno-8-116"></a><span class="w">        </span><span class="nt">minimum</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">0</span>
</span><span id="__span-8-117"><a id="__codelineno-8-117" name="__codelineno-8-117" href="#__codelineno-8-117"></a><span class="w">        </span><span class="nt">title</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Heating</span>
</span><span id="__span-8-118"><a id="__codelineno-8-118" name="__codelineno-8-118" href="#__codelineno-8-118"></a><span class="w">        </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">number</span>
</span><span id="__span-8-119"><a id="__codelineno-8-119" name="__codelineno-8-119" href="#__codelineno-8-119"></a><span class="w">      </span><span class="nt">lighting</span><span class="p">:</span>
</span><span id="__span-8-120"><a id="__codelineno-8-120" name="__codelineno-8-120" href="#__codelineno-8-120"></a><span class="w">        </span><span class="nt">description</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Annual lighting energy usage, kWh/m2</span>
</span><span id="__span-8-121"><a id="__codelineno-8-121" name="__codelineno-8-121" href="#__codelineno-8-121"></a><span class="w">        </span><span class="nt">minimum</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">0</span>
</span><span id="__span-8-122"><a id="__codelineno-8-122" name="__codelineno-8-122" href="#__codelineno-8-122"></a><span class="w">        </span><span class="nt">title</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Lighting</span>
</span><span id="__span-8-123"><a id="__codelineno-8-123" name="__codelineno-8-123" href="#__codelineno-8-123"></a><span class="w">        </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">number</span>
</span><span id="__span-8-124"><a id="__codelineno-8-124" name="__codelineno-8-124" href="#__codelineno-8-124"></a><span class="w">      </span><span class="nt">pumps</span><span class="p">:</span>
</span><span id="__span-8-125"><a id="__codelineno-8-125" name="__codelineno-8-125" href="#__codelineno-8-125"></a><span class="w">        </span><span class="nt">description</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Annual pumps energy usage, kWh/m2</span>
</span><span id="__span-8-126"><a id="__codelineno-8-126" name="__codelineno-8-126" href="#__codelineno-8-126"></a><span class="w">        </span><span class="nt">minimum</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">0</span>
</span><span id="__span-8-127"><a id="__codelineno-8-127" name="__codelineno-8-127" href="#__codelineno-8-127"></a><span class="w">        </span><span class="nt">title</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Pumps</span>
</span><span id="__span-8-128"><a id="__codelineno-8-128" name="__codelineno-8-128" href="#__codelineno-8-128"></a><span class="w">        </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">number</span>
</span><span id="__span-8-129"><a id="__codelineno-8-129" name="__codelineno-8-129" href="#__codelineno-8-129"></a><span class="w">    </span><span class="nt">required</span><span class="p">:</span>
</span><span id="__span-8-130"><a id="__codelineno-8-130" name="__codelineno-8-130" href="#__codelineno-8-130"></a><span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">heating</span>
</span><span id="__span-8-131"><a id="__codelineno-8-131" name="__codelineno-8-131" href="#__codelineno-8-131"></a><span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">cooling</span>
</span><span id="__span-8-132"><a id="__codelineno-8-132" name="__codelineno-8-132" href="#__codelineno-8-132"></a><span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">lighting</span>
</span><span id="__span-8-133"><a id="__codelineno-8-133" name="__codelineno-8-133" href="#__codelineno-8-133"></a><span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">equipment</span>
</span><span id="__span-8-134"><a id="__codelineno-8-134" name="__codelineno-8-134" href="#__codelineno-8-134"></a><span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">fans</span>
</span><span id="__span-8-135"><a id="__codelineno-8-135" name="__codelineno-8-135" href="#__codelineno-8-135"></a><span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">pumps</span>
</span><span id="__span-8-136"><a id="__codelineno-8-136" name="__codelineno-8-136" href="#__codelineno-8-136"></a><span class="w">    </span><span class="nt">title</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">BuildingSimulationOutput</span>
</span><span id="__span-8-137"><a id="__codelineno-8-137" name="__codelineno-8-137" href="#__codelineno-8-137"></a><span class="w">    </span><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">object</span>
</span><span id="__span-8-138"><a id="__codelineno-8-138" name="__codelineno-8-138" href="#__codelineno-8-138"></a><span class="nt">description</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">The input and output schema for the experiment.</span>
</span><span id="__span-8-139"><a id="__codelineno-8-139" name="__codelineno-8-139" href="#__codelineno-8-139"></a><span class="nt">properties</span><span class="p">:</span>
</span><span id="__span-8-140"><a id="__codelineno-8-140" name="__codelineno-8-140" href="#__codelineno-8-140"></a><span class="w">  </span><span class="nt">input</span><span class="p">:</span>
</span><span id="__span-8-141"><a id="__codelineno-8-141" name="__codelineno-8-141" href="#__codelineno-8-141"></a><span class="w">    </span><span class="nt">$ref</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;#/$defs/BuildingSimulationInput&quot;</span>
</span><span id="__span-8-142"><a id="__codelineno-8-142" name="__codelineno-8-142" href="#__codelineno-8-142"></a><span class="w">    </span><span class="nt">description</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">The input for the experiment.</span>
</span><span id="__span-8-143"><a id="__codelineno-8-143" name="__codelineno-8-143" href="#__codelineno-8-143"></a><span class="w">  </span><span class="nt">output</span><span class="p">:</span>
</span><span id="__span-8-144"><a id="__codelineno-8-144" name="__codelineno-8-144" href="#__codelineno-8-144"></a><span class="w">    </span><span class="nt">$ref</span><span class="p">:</span><span class="w"> </span><span class="s">&quot;#/$defs/BuildingSimulationOutput&quot;</span>
</span><span id="__span-8-145"><a id="__codelineno-8-145" name="__codelineno-8-145" href="#__codelineno-8-145"></a><span class="w">    </span><span class="nt">description</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">The output for the experiment.</span>
</span><span id="__span-8-146"><a id="__codelineno-8-146" name="__codelineno-8-146" href="#__codelineno-8-146"></a><span class="nt">required</span><span class="p">:</span>
</span><span id="__span-8-147"><a id="__codelineno-8-147" name="__codelineno-8-147" href="#__codelineno-8-147"></a><span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">input</span>
</span><span id="__span-8-148"><a id="__codelineno-8-148" name="__codelineno-8-148" href="#__codelineno-8-148"></a><span class="w">  </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">output</span>
</span><span id="__span-8-149"><a id="__codelineno-8-149" name="__codelineno-8-149" href="#__codelineno-8-149"></a><span class="nt">title</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">ExperimentIO</span>
</span><span id="__span-8-150"><a id="__codelineno-8-150" name="__codelineno-8-150" href="#__codelineno-8-150"></a><span class="nt">type</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">object</span>
</span></code></pre></div>
<h2 id="scythe-from-a-developer-perspective">Scythe - from a developer perspective<a class="headerlink" href="#scythe-from-a-developer-perspective" title="Permanent link">#</a></h2>
<h3 id="requirements">Requirements<a class="headerlink" href="#requirements" title="Permanent link">#</a></h3>
<p>The key design requirement that I wanted to satisfy was to make it easy for an academic/engineer
to quickly define what the interface and business logic of a single experiment task would be
and then quickly convert that into a massively parallel experiment with well structured,
pre-collected outputs. This means we will want to be able to automatically detect and
serialize both inputs and outputs into a dataframe-like format. It also means we will want
to automatically handle serializing local artifacts required by simulations into S3 (for me,
these might be boundary condition specs, like the <code>.epw</code> format weather files used in building
simulations). We also want good records of what the specifications for the experiment were,
both at the interface level (i.e. what was the configuration/meaning of inputs and outputs)
and at the instance level (which specific values of the interfaces' inputs were used).</p>
<h3 id="core-design-decisions">Core design decisions<a class="headerlink" href="#core-design-decisions" title="Permanent link">#</a></h3>
<h4 id="middleware-for-individual-simulation-tasks">Middleware for individual simulation tasks<a class="headerlink" href="#middleware-for-individual-simulation-tasks" title="Permanent link">#</a></h4>
<p>Hatchet already relies on decorators to let users define tasks - the core of Scythe's
most important features from a user perspective are really just creating an additional level
of decoration so that we can add some convenience middleware functionality to run before
and after a simulation run.</p>
<p>You normally define a Hatchet task like this:</p>
<div class="language-py highlight"><pre><span></span><code><span id="__span-9-1"><a id="__codelineno-9-1" name="__codelineno-9-1" href="#__codelineno-9-1"></a><span class="nd">@hatchet</span><span class="o">.</span><span class="n">task</span><span class="p">(</span><span class="o">...</span><span class="p">)</span>
</span><span id="__span-9-2"><a id="__codelineno-9-2" name="__codelineno-9-2" href="#__codelineno-9-2"></a><span class="k">def</span><span class="w"> </span><span class="nf">my_task</span><span class="p">(</span><span class="n">input_spec</span><span class="p">:</span> <span class="n">T</span><span class="p">,</span> <span class="n">ctx</span><span class="p">:</span> <span class="n">Context</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">RT</span><span class="p">:</span>
</span><span id="__span-9-3"><a id="__codelineno-9-3" name="__codelineno-9-3" href="#__codelineno-9-3"></a>  <span class="o">...</span>
</span><span id="__span-9-4"><a id="__codelineno-9-4" name="__codelineno-9-4" href="#__codelineno-9-4"></a>  <span class="k">return</span> <span class="n">RT</span><span class="p">(</span><span class="o">...</span><span class="p">)</span>
</span></code></pre></div>
<p>but we want some middleware to run, so we will shadow the Hatchet task decorator with our
own which will work effectively the same as the Hatchet one (up to whichever Hatchet task
config args we expose) by constructing the same task as the user would have, but because
we control the Hatchet task creation, we can choose to run our middleware before and after
the user's function is executed. Another important aspect is that it allows us to achieve type-safety to ensure that the user's simulation function's input and output types subclass <code>ExperimentInputSpec</code> and <code>ExperimentOutputSpec</code> respectively.</p>
<div class="language-py highlight"><span class="filename">scythe/registry.py</span><pre><span></span><code><span id="__span-10-1"><a id="__codelineno-10-1" name="__codelineno-10-1" href="#__codelineno-10-1"></a><span class="k">class</span><span class="w"> </span><span class="nc">ExperimentRegistry</span><span class="p">:</span>
</span><span id="__span-10-2"><a id="__codelineno-10-2" name="__codelineno-10-2" href="#__codelineno-10-2"></a>  <span class="o">...</span>
</span><span id="__span-10-3"><a id="__codelineno-10-3" name="__codelineno-10-3" href="#__codelineno-10-3"></a>
</span><span id="__span-10-4"><a id="__codelineno-10-4" name="__codelineno-10-4" href="#__codelineno-10-4"></a>  <span class="nd">@classmethod</span>
</span><span id="__span-10-5"><a id="__codelineno-10-5" name="__codelineno-10-5" href="#__codelineno-10-5"></a>  <span class="k">def</span><span class="w"> </span><span class="nf">Register</span><span class="p">(</span>
</span><span id="__span-10-6"><a id="__codelineno-10-6" name="__codelineno-10-6" href="#__codelineno-10-6"></a>    <span class="o">...</span><span class="n">args</span><span class="p">,</span> <span class="c1"># (1)!</span>
</span><span id="__span-10-7"><a id="__codelineno-10-7" name="__codelineno-10-7" href="#__codelineno-10-7"></a>    <span class="o">...</span><span class="n">passthrough_args</span><span class="p">,</span> <span class="c1"># (2)!</span>
</span><span id="__span-10-8"><a id="__codelineno-10-8" name="__codelineno-10-8" href="#__codelineno-10-8"></a>  <span class="p">):</span>
</span><span id="__span-10-9"><a id="__codelineno-10-9" name="__codelineno-10-9" href="#__codelineno-10-9"></a>
</span><span id="__span-10-10"><a id="__codelineno-10-10" name="__codelineno-10-10" href="#__codelineno-10-10"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">decorator</span><span class="p">(</span><span class="n">fn</span><span class="p">:</span> <span class="n">Callable</span><span class="p">[[</span><span class="n">T</span><span class="p">,],</span> <span class="n">RT</span><span class="p">]):</span> <span class="c1"># (3)!</span>
</span><span id="__span-10-11"><a id="__codelineno-10-11" name="__codelineno-10-11" href="#__codelineno-10-11"></a>
</span><span id="__span-10-12"><a id="__codelineno-10-12" name="__codelineno-10-12" href="#__codelineno-10-12"></a>      <span class="nd">@hatchet</span><span class="o">.</span><span class="n">task</span><span class="p">(</span><span class="o">...</span><span class="n">passthrough_args</span><span class="p">)</span> <span class="c1"># (4)!</span>
</span><span id="__span-10-13"><a id="__codelineno-10-13" name="__codelineno-10-13" href="#__codelineno-10-13"></a>      <span class="k">def</span><span class="w"> </span><span class="nf">task</span><span class="p">(</span><span class="n">input_spec</span><span class="p">:</span> <span class="n">T</span><span class="p">,</span> <span class="n">ctx</span><span class="p">:</span> <span class="n">Context</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">RT</span><span class="p">:</span>
</span><span id="__span-10-14"><a id="__codelineno-10-14" name="__codelineno-10-14" href="#__codelineno-10-14"></a>
</span><span id="__span-10-15"><a id="__codelineno-10-15" name="__codelineno-10-15" href="#__codelineno-10-15"></a>        <span class="c1"># Set up a working directory</span>
</span><span id="__span-10-16"><a id="__codelineno-10-16" name="__codelineno-10-16" href="#__codelineno-10-16"></a>        <span class="k">with</span> <span class="n">tempdir</span><span class="o">.</span><span class="n">TemporaryDirectory</span> <span class="k">as</span> <span class="n">temp_dir</span><span class="p">:</span>
</span><span id="__span-10-17"><a id="__codelineno-10-17" name="__codelineno-10-17" href="#__codelineno-10-17"></a>
</span><span id="__span-10-18"><a id="__codelineno-10-18" name="__codelineno-10-18" href="#__codelineno-10-18"></a>          <span class="c1"># Middleware execution happens here, like fetching input artifacts to local dir</span>
</span><span id="__span-10-19"><a id="__codelineno-10-19" name="__codelineno-10-19" href="#__codelineno-10-19"></a>          <span class="o">...</span>
</span><span id="__span-10-20"><a id="__codelineno-10-20" name="__codelineno-10-20" href="#__codelineno-10-20"></a>
</span><span id="__span-10-21"><a id="__codelineno-10-21" name="__codelineno-10-21" href="#__codelineno-10-21"></a>          <span class="c1"># Call the user supplied function</span>
</span><span id="__span-10-22"><a id="__codelineno-10-22" name="__codelineno-10-22" href="#__codelineno-10-22"></a>          <span class="n">result</span><span class="p">:</span> <span class="n">RT</span> <span class="o">=</span> <span class="n">fn</span><span class="p">(</span><span class="n">T</span><span class="p">,</span> <span class="n">tempdir</span><span class="o">=</span><span class="n">Path</span><span class="p">(</span><span class="n">tempdir</span><span class="p">))</span>
</span><span id="__span-10-23"><a id="__codelineno-10-23" name="__codelineno-10-23" href="#__codelineno-10-23"></a>
</span><span id="__span-10-24"><a id="__codelineno-10-24" name="__codelineno-10-24" href="#__codelineno-10-24"></a>          <span class="c1"># More middleware execution happens here, like uploading FileReferences to S3</span>
</span><span id="__span-10-25"><a id="__codelineno-10-25" name="__codelineno-10-25" href="#__codelineno-10-25"></a>          <span class="o">...</span>
</span><span id="__span-10-26"><a id="__codelineno-10-26" name="__codelineno-10-26" href="#__codelineno-10-26"></a>
</span><span id="__span-10-27"><a id="__codelineno-10-27" name="__codelineno-10-27" href="#__codelineno-10-27"></a>        <span class="k">return</span> <span class="n">result</span>
</span><span id="__span-10-28"><a id="__codelineno-10-28" name="__codelineno-10-28" href="#__codelineno-10-28"></a>
</span><span id="__span-10-29"><a id="__codelineno-10-29" name="__codelineno-10-29" href="#__codelineno-10-29"></a>      <span class="k">return</span> <span class="n">task</span>
</span><span id="__span-10-30"><a id="__codelineno-10-30" name="__codelineno-10-30" href="#__codelineno-10-30"></a>
</span><span id="__span-10-31"><a id="__codelineno-10-31" name="__codelineno-10-31" href="#__codelineno-10-31"></a>
</span><span id="__span-10-32"><a id="__codelineno-10-32" name="__codelineno-10-32" href="#__codelineno-10-32"></a>    <span class="k">return</span> <span class="n">decorator</span> <span class="c1"># (5)!</span>
</span></code></pre></div>
<ol>
<li>We will have some arguments to our decorator which we can use to control the behavior of Scythe.</li>
<li>We will have some other arguments which we will pass through to Hatchet's <code>task</code> decorator.</li>
<li>We will enforce type safety generically here to ensure that the signature of the function defined by the user accepts a subclass of <code>ExperimentInputSpec</code> and returns a subclass of <code>ExperimentOutputSpec</code> so that we can</li>
<li>Here we create the Hatchet task for a function which we control which will wrap and invoke the user-supplied function.</li>
<li>When the user calls our decorator function with arguments, we return the uncalled inner decorator function, which in turn gets called by Python automatically on their decorated function; this finally returns the Hatchet task version of that function.</li>
</ol>
<p>This middleware will be responsible for the following:</p>
<ol>
<li>Setting up a temporary directory which the simulation function can use as a safe working dir which will be automatically cleaned up.</li>
<li>Pulling any referenced artifacts into a locally scoped dir for use in the simulation function while leveraging a filecache to avoid excessive data ingress when lots of tasks use commonly shared files (e.g. weather files for my case of building energy simulations).</li>
<li>Taking the result, converting the scalar outputs
   into a well-formatted dataframe with a consistently structured index based off of the input payload so that it can be combined
   with the results of other simulations into a large aggregated dataframe of outputs across all runs</li>
<li>Transferring any file-based outputs to S3 and referencing them in an artifact output tracking dataframe.</li>
</ol>
<p>While the main fields of the output class will get automatically converted into well-structured data
for aggregation by the scatter/gather task with results from all the other simulations,
we still might have some individual file based outputs per simulation (maybe logs, maybe images or timeseries etc.). If each simulation generates large amounts of data (e.g. high-resolution hourly timeseries
data or images), it's probably not a great idea to try to collect all of this into a single
file, like we do with the <code>scalars</code> or user dataframes. For instance, if each building energy
simulation outputs 15-min timesteps of heating, cooling, lighting, equipment, and hot water
loads for a whole year in 32bit floats, that would be <code>15 * 8760 * 5 * 4 ~= 2.6e6 = 2.6 MB</code>
If we have just 1e6 simulations, then we are already at 2.6 TB of raw data. Most likely a better
approach would be to first be judicious about what you actually need - e.g. maybe you only
need hourly data for just heating and cooling, and maybe you can stochastically drop some
fraction of results, etc. In any case, you stil probably do not want to combine all of the results
into a single output dataframe/record. Instead, we probably still will want to write out
a single file per simulation to S3 and store a reference to that record, which can then
be used in the future in some dataloader-like approach, effectively creating a mini datalake -
data warehouse? That's exactly what the post-run middleware takes care of.</p>
<h4 id="scattergather-divide-conquer">Scatter/gather: divide &amp; conquer<a class="headerlink" href="#scattergather-divide-conquer" title="Permanent link">#</a></h4>
<p>Scythe uses a divide-and-conquer strategy to maximize allocation/collection throughput with
recursive subdivision. Let's understand why it helps by working through an example.</p>
<p>Let's say we have 1e7 simulations to run, and each simulation takes 2-3 seconds to complete.</p>
<p>We will have some worker nodes which are responsible for taking the specifications for all simulations
from a parquet file and enqueuing the simulations, and then a much larger pool of worker nodes
which are responsible for executing the simulations; the enqueuing workers will also be
responsible for gathering and combining results.</p>
<p>Now let's suppose we can add simulations to Hatchet's queue at approximately a rate of 100
tasks/s from a single enqueuing worker. It will take that worker 1e5s ~= 1 day to enqueue all the
tasks. More problematic though is that if we spin up 400 worker nodes, we will be completing
on average 400 tasks every 2.5 seconds, or an average of 160 tasks/second. Except we only have
100 tasks reaching the queue per second, and we will be bottlenecked with lots of compute nodes
sitting idle! How can we get around this?</p>
<p>We can get around it by recursively subdividing the original batch of 1e7 simulations into smaller
batches, which in turn either get subdvided again or if the recursion base case tripwire is
triggered, then the remaining batch gets added to the queue as actual simulations to run.</p>
<p>As an example, let's consider a single subdivision level with a branching factor of 10. The
root scatter/gather task will download the complete experiment specs parquet file from S3,
break it up into 10 equally sized pieces (or 9 equally sized pieces + some left overs),
and then create children tasks which perform the scatter/gather logic on the trimmed batches.
Since we only set a single subdivision level, these children will be responsible for actual
adding the individual task specs for the simulations to the Hatchet queue. This means we
now have 10 children scatter/gather tasks, which each have 1e6 simulations to enqueue, which,
assuming the engine can handle the additional worker throughput, means 1000 tasks/s enqueued. This
means we can now bump up to 2500 leaf simulation worker nodes, which would average 1000 tasks
completed per second since tasks take an average of 2.5s. Our entire experiment of 1e7
runs should be completed in 2 hours and 45 min, give or take.</p>
<p>Now, suppose we choose to instead use two levels of recursive subdivision. Then we will end
up with 100 enqueuing workers, which would mean 10k tasks/s enqueued (if the engine can handle
it), and we could theoretically use 25k workers, and be done in 15 minutes. However, realistically,
you probably will be limited by your AWS service quota at something like 5k-10k worker nodes.
Additionally, the Hatchet engine, if self-deployed, might not be able to support 10k tasks/s
enqueuing or finishing. However, there are still significant benefits to using a higher branching
factor when it comes to collecting results.</p>
<p>When a terminal scatter/gather task is collecting its leaf/children simulation tasks' results,
it's pulling them directly from Hatchet, and we will be limited by whatever the throughput there is.
However, it will combine those results into a parquet file(s), which will be serialized
and sent to S3 and the scatter/gather task will return a thin payload with an S3 URI(s).
The predecessor scatter/gather task in the tree will be responsible for collecting the S3 URIs
of its children, retrieving them from s3, combining them, and then serializing the combined
version back to S3, and passing a thin payload output up the tree, until eventually we
get to the root scatter gather task. This is where the recursive subdivision really shines,
as it can greatly reduce the amount of time it takes to collect and combine results by breaking
it up into parallelized tasks, especially since we can use ThreadPoolExecutors to parallelize the
network-bound process of pulling the children's thin URI payloads from S3.</p>
<h4 id="dealing-with-thick-thin-payloads">Dealing with thick &amp; thin payloads<a class="headerlink" href="#dealing-with-thick-thin-payloads" title="Permanent link">#</a></h4>
<p>Hatchet's task payload size is limited to something like 4MB (correct me if I'm wrong @hatchet-dev team!).
This means that if we are 1e6 simulations, we most likely would not be able to submit the
task as the payload containing all of the information for all of the simulations would be
too large. The typical way around this is to serialize the payload, store it somewhere else,
and then submit a reference to that payload in the actual scatter/gather fanout task spec.</p>
<p>In an earlier version, I allowed the scatter/gather input spec to accept <em>either</em> a list of
task specs <em>or</em> a reference to a file containing all the task specs, but some of the code
around that got pretty gross, so in the latest version I decided to only support S3 URIs.</p>
<div class="language-py highlight"><pre><span></span><code><span id="__span-11-1"><a id="__codelineno-11-1" name="__codelineno-11-1" href="#__codelineno-11-1"></a><span class="k">class</span><span class="w"> </span><span class="nc">ScatterGatherInput</span><span class="p">(</span><span class="n">BaseSpec</span><span class="p">):</span>
</span><span id="__span-11-2"><a id="__codelineno-11-2" name="__codelineno-11-2" href="#__codelineno-11-2"></a><span class="w">    </span><span class="sd">&quot;&quot;&quot;Input for the scatter gather workflow.&quot;&quot;&quot;</span>
</span><span id="__span-11-3"><a id="__codelineno-11-3" name="__codelineno-11-3" href="#__codelineno-11-3"></a>
</span><span id="__span-11-4"><a id="__codelineno-11-4" name="__codelineno-11-4" href="#__codelineno-11-4"></a>    <span class="n">task_name</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="o">...</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;The name of the Hatchet task to run.&quot;</span><span class="p">)</span>
</span><span id="__span-11-5"><a id="__codelineno-11-5" name="__codelineno-11-5" href="#__codelineno-11-5"></a>    <span class="n">specs_uri</span><span class="p">:</span> <span class="n">S3Url</span> <span class="o">=</span> <span class="n">Field</span><span class="p">(</span><span class="o">...</span><span class="p">,</span> <span class="n">description</span><span class="o">=</span><span class="s2">&quot;The path to the specs to run.&quot;</span><span class="p">)</span> <span class="c1"># (1)!</span>
</span><span id="__span-11-6"><a id="__codelineno-11-6" name="__codelineno-11-6" href="#__codelineno-11-6"></a>
</span><span id="__span-11-7"><a id="__codelineno-11-7" name="__codelineno-11-7" href="#__codelineno-11-7"></a>    <span class="o">...</span> <span class="c1"># (3)!</span>
</span><span id="__span-11-8"><a id="__codelineno-11-8" name="__codelineno-11-8" href="#__codelineno-11-8"></a>
</span><span id="__span-11-9"><a id="__codelineno-11-9" name="__codelineno-11-9" href="#__codelineno-11-9"></a>
</span><span id="__span-11-10"><a id="__codelineno-11-10" name="__codelineno-11-10" href="#__codelineno-11-10"></a>    <span class="nd">@cached_property</span>
</span><span id="__span-11-11"><a id="__codelineno-11-11" name="__codelineno-11-11" href="#__codelineno-11-11"></a>    <span class="k">def</span><span class="w"> </span><span class="nf">specs</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">list</span><span class="p">[</span><span class="n">ExperimentInputSpec</span><span class="p">]:</span> <span class="c1"># (2)!</span>
</span><span id="__span-11-12"><a id="__codelineno-11-12" name="__codelineno-11-12" href="#__codelineno-11-12"></a><span class="w">        </span><span class="sd">&quot;&quot;&quot;Fetch the specs and convert to the input type.&quot;&quot;&quot;</span>
</span><span id="__span-11-13"><a id="__codelineno-11-13" name="__codelineno-11-13" href="#__codelineno-11-13"></a>        <span class="n">local_path</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fetch_uri</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">specs_uri</span><span class="p">,</span> <span class="n">use_cache</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span><span id="__span-11-14"><a id="__codelineno-11-14" name="__codelineno-11-14" href="#__codelineno-11-14"></a>        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_parquet</span><span class="p">(</span><span class="n">local_path</span><span class="p">)</span>
</span><span id="__span-11-15"><a id="__codelineno-11-15" name="__codelineno-11-15" href="#__codelineno-11-15"></a>        <span class="n">specs_dicts</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">to_dict</span><span class="p">(</span><span class="n">orient</span><span class="o">=</span><span class="s2">&quot;records&quot;</span><span class="p">)</span>
</span><span id="__span-11-16"><a id="__codelineno-11-16" name="__codelineno-11-16" href="#__codelineno-11-16"></a>        <span class="n">validator</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">standalone</span><span class="o">.</span><span class="n">input_validator</span>
</span><span id="__span-11-17"><a id="__codelineno-11-17" name="__codelineno-11-17" href="#__codelineno-11-17"></a>        <span class="k">return</span> <span class="p">[</span><span class="n">validator</span><span class="o">.</span><span class="n">model_validate</span><span class="p">(</span><span class="n">spec</span><span class="p">)</span> <span class="k">for</span> <span class="n">spec</span> <span class="ow">in</span> <span class="n">specs_dicts</span><span class="p">]</span>
</span></code></pre></div>
<ol>
<li>This is where we pass in a URI which which stores the complete set of leaf task specifications.</li>
<li>We can now access a cached, opened version of the full spec list inside of a scatter/gather task with <code>payload.specs</code></li>
<li>Additional fields and methods omitted for brevity.</li>
</ol>
<p>We also do something similar with results outputs - while each individual simulation/experiment
task can safely return a Pydantic model containing the actual results, as soon as we start
combining the results of multiple experiments, we will exceed the output payload size,
so we use the same "thin" payload approach.</p>
<p>If a scatter/gather task is a terminal node which actually allocated the leaf experiment
tasks, then when it is done, it simply combines the results of all of the children tasks
into a dataframe (or dataframes if the user also added user-defined dataframes to the
corresponding key of the output model); these get uploaded to S3 in an "intermediate results"
section of the experiment's directory within the bucket. It returns a reference to each
of the dataframes it wrote to S3. Then, a predecessor scatter/gather tasks on earlier
levels of the tree simply collect the dataframes generated by each of <em>its</em> children
scatter/gather tasks, combines them, writes to S3, and returns URIs. The root scatter/gather
task then ultimately does the exact same thing, resulting in a single set of dataframes
with results from every simulation, e.g. one dataframe for all of the scalars, and one
dataframe for each of the custom user-defined dataframes in the task output.</p>
<h2 id="cloud-infrastructure">Cloud Infrastructure<a class="headerlink" href="#cloud-infrastructure" title="Permanent link">#</a></h2>
<p>This will assume that you have at least some knowledge of
<a href="https://docker.com">Docker</a> and containers, but otherwise will try to introduce you to
some of the key parts of the cloud deployment - and really cloud computing in general. It
covers some stuff that's pretty boring but it's not something that you will really learn
in the normal course of your academic research, and it's ultimately relatively simple to
at least get to working knowledge with, so I think it's worth covering here.</p>
<blockquote>
<p>(skip to <a href="#deploying-containers">Deploying Containers</a> if you are familiar with Docker
but not ECS, otherwise skip this section entirely and go to <a href="#self-hosting-hatchet-as-an-intro-to-cloud-configuration">Self-hosting</a>
or <a href="#worker-nodes">Worker nodes</a>)</p>
</blockquote>
<h3 id="containerization">Containerization<a class="headerlink" href="#containerization" title="Permanent link">#</a></h3>
<blockquote>
<p>The Docker documentation is extensive and great, especially the
<a href="https://docs.docker.com/get-started/">Getting Started Guide</a>, so I recommend you start
there. There are also countless guides online. Still, I think it is worthwhile to try
to condense everything in one place so you get a good understanding of how all the pieces
fit together.</p>
</blockquote>
<p>If you work in academia, you are probably familiar with Python tools like
<a href="https://anaconda.org/anaconda/conda">Conda</a>, <a href="https://astral.sh/uv">uv</a>, and
<a href="https://python-poetry.org">Poetry</a>, or if you are coming from the web world you are probably familiar with npm/pnpm.
All of these enable you to consistently define and to some extent package the dependencies
of your project so that you can, hopefully, on another machine, easily reproduce the <em>environment</em> you used
to write your software and still have your code run. There are of course still all sorts of
issues you might run into, like needing Python + Conda/uv/Poetry or Node + npm/pnpm installed,
their might be incompatibilities with the version of Python/Node or the other machine's architecture,
etc. uv and nvm/pnpm do help with these, but it still can be a pain. Plus, there might
be all sorts of other dependencies which cannot be captured by those tools, like, for me,
<a href="https://energyplus.net/">EnergyPlus</a>, the de facto standard for building energy model simulation
in practice and academia (developed and maintained by the DoE and NREL).</p>
<p>Docker images and containers address this exact issue. You can think of
<em>images</em> as a pre-built artifact which contains everything you need to run a <em>container</em>,
which you can think of (even if it's not exactly true) an isolated, mini virtual machine
that has everything installed and working perfectly already, letting you easily reproduce
an entire application, including any necessary dependencies, environment variables, system
libraries, binaries, etc. Think of it like shipping your lab experiment in a fully
stocked portable lab that can run identically anywhere, no matter the underlying hardware
or OS. This means that images + containers are the de-facto standard for deploying applications
in the cloud - you just need to tell your cloud infrastructure "hey go fetch this image
and run it in a container." You typically store the containers in a repository which lets
you define different tags, i.e. versions, as it evolves over time, just like GitHub. The
most common container registry to use is probalby <em>Elastic Container Registry</em> <a href="https://aws.amazon.com/ecr/">(<em>ECR</em>)</a> on
AWS of <em>GitHub Container Repository</em> <a href="https://ghcr.io">(<em>GHCR</em>)</a>.</p>
<p>You define the image of a container using a <em>Dockerfile</em>, which typically starts by inheriting
from another image (typically based off of some lightweight Linux distributino) which
has most of what you need already, like Python etc. Then, you copy over your project files,
install anything you need to, and set what command should run when a container for this
image is started up.</p>
<h4 id="dockerfile-example">Dockerfile example<a class="headerlink" href="#dockerfile-example" title="Permanent link">#</a></h4>
<p>Let's take a look at this in practice. Suppose we have a standard Python repo which uses
<code>uv</code> for its dependency management. There's a <code>pyproject.toml</code> file which configures
our project as usual, along with a <code>uv.lock</code> file which has all the precise dependency
version information locked, and then some code in our <code>experiments/</code> dir and a <code>main.py</code>
file which looks like this:</p>
<div class="language-py highlight"><span class="filename">main.py</span><pre><span></span><code><span id="__span-12-1"><a id="__codelineno-12-1" name="__codelineno-12-1" href="#__codelineno-12-1"></a><span class="kn">from</span><span class="w"> </span><span class="nn">scythe.worker</span><span class="w"> </span><span class="kn">import</span> <span class="n">ScytheWorkerConfig</span>
</span><span id="__span-12-2"><a id="__codelineno-12-2" name="__codelineno-12-2" href="#__codelineno-12-2"></a>
</span><span id="__span-12-3"><a id="__codelineno-12-3" name="__codelineno-12-3" href="#__codelineno-12-3"></a><span class="kn">from</span><span class="w"> </span><span class="nn">experiments</span><span class="w"> </span><span class="kn">import</span> <span class="o">*</span>  <span class="c1"># import the experiments so that they get auto-registered</span>
</span><span id="__span-12-4"><a id="__codelineno-12-4" name="__codelineno-12-4" href="#__codelineno-12-4"></a>
</span><span id="__span-12-5"><a id="__codelineno-12-5" name="__codelineno-12-5" href="#__codelineno-12-5"></a>
</span><span id="__span-12-6"><a id="__codelineno-12-6" name="__codelineno-12-6" href="#__codelineno-12-6"></a><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
</span><span id="__span-12-7"><a id="__codelineno-12-7" name="__codelineno-12-7" href="#__codelineno-12-7"></a>    <span class="n">worker_config</span> <span class="o">=</span> <span class="n">ScytheWorkerConfig</span><span class="p">()</span>
</span><span id="__span-12-8"><a id="__codelineno-12-8" name="__codelineno-12-8" href="#__codelineno-12-8"></a>    <span class="n">worker_config</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
</span></code></pre></div>
<p>In the following Dockerfile, we inherit from a lightweight image with
Python pre-installed, then we copy over the binaries for <code>uv</code> from a pre-existing image
released by Astral, the creators of <code>uv</code>. Then we copy over anything from our codebase
we need, install our Python dependencies with <code>uv</code>, and then, specify what command to run
when starting a container up with this image.</p>
<div class="language-dockerfile highlight"><span class="filename">Dockerfile.worker</span><pre><span></span><code><span id="__span-13-1"><a id="__codelineno-13-1" name="__codelineno-13-1" href="#__codelineno-13-1"></a><span class="k">ARG</span><span class="w"> </span><span class="nv">PYTHON_VERSION</span><span class="o">=</span><span class="m">3</span>.12
</span><span id="__span-13-2"><a id="__codelineno-13-2" name="__codelineno-13-2" href="#__codelineno-13-2"></a><span class="k">FROM</span><span class="w"> </span><span class="s">python:${PYTHON_VERSION}-slim-bookworm</span><span class="w"> </span><span class="k">AS</span><span class="w"> </span><span class="s">main</span>
</span><span id="__span-13-3"><a id="__codelineno-13-3" name="__codelineno-13-3" href="#__codelineno-13-3"></a><span class="k">COPY</span><span class="w"> </span>--from<span class="o">=</span>ghcr.io/astral-sh/uv:0.6.16<span class="w"> </span>/uv<span class="w"> </span>/uvx<span class="w"> </span>/bin/
</span><span id="__span-13-4"><a id="__codelineno-13-4" name="__codelineno-13-4" href="#__codelineno-13-4"></a>
</span><span id="__span-13-5"><a id="__codelineno-13-5" name="__codelineno-13-5" href="#__codelineno-13-5"></a><span class="k">WORKDIR</span><span class="w"> </span><span class="s">/code</span>
</span><span id="__span-13-6"><a id="__codelineno-13-6" name="__codelineno-13-6" href="#__codelineno-13-6"></a><span class="k">COPY</span><span class="w"> </span>uv.lock<span class="w"> </span>pyproject.toml<span class="w"> </span>README.md<span class="w"> </span>/code/
</span><span id="__span-13-7"><a id="__codelineno-13-7" name="__codelineno-13-7" href="#__codelineno-13-7"></a>
</span><span id="__span-13-8"><a id="__codelineno-13-8" name="__codelineno-13-8" href="#__codelineno-13-8"></a><span class="k">RUN</span><span class="w"> </span>uv<span class="w"> </span>sync<span class="w"> </span>--locked<span class="w"> </span>--no-install-project
</span><span id="__span-13-9"><a id="__codelineno-13-9" name="__codelineno-13-9" href="#__codelineno-13-9"></a>
</span><span id="__span-13-10"><a id="__codelineno-13-10" name="__codelineno-13-10" href="#__codelineno-13-10"></a><span class="k">COPY</span><span class="w"> </span>experiments<span class="w"> </span>/code/experiments/
</span><span id="__span-13-11"><a id="__codelineno-13-11" name="__codelineno-13-11" href="#__codelineno-13-11"></a><span class="k">COPY</span><span class="w"> </span>main.py<span class="w"> </span>/code/main.py
</span><span id="__span-13-12"><a id="__codelineno-13-12" name="__codelineno-13-12" href="#__codelineno-13-12"></a>
</span><span id="__span-13-13"><a id="__codelineno-13-13" name="__codelineno-13-13" href="#__codelineno-13-13"></a><span class="k">RUN</span><span class="w"> </span>uv<span class="w"> </span>sync<span class="w"> </span>--locked
</span><span id="__span-13-14"><a id="__codelineno-13-14" name="__codelineno-13-14" href="#__codelineno-13-14"></a>
</span><span id="__span-13-15"><a id="__codelineno-13-15" name="__codelineno-13-15" href="#__codelineno-13-15"></a><span class="k">CMD</span><span class="w"> </span><span class="p">[</span><span class="w"> </span><span class="s2">&quot;uv&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;run&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;main.py&quot;</span><span class="w"> </span><span class="p">]</span>
</span></code></pre></div>
<p>We can build this container with <code>docker build -f path/to/your/Dockefile .</code></p>
<p>Once the image is built, we can run it, tag it, push it to a repository, etc. However,
generally, we use our infrastructure-as-code or CI/CD tooling to manage that for us.</p>
<h4 id="docker-compose-example">Docker Compose example<a class="headerlink" href="#docker-compose-example" title="Permanent link">#</a></h4>
<p>Often times, we need multiple containers running at the same time - maybe a frontend and
a backend, or in our case, the Hatchet task system - which itself needs a few containers for
its different components like a database, broker, engine, dashboard, etc. That's
where
<a href="https://docs.docker.com/get-started/docker-concepts/running-containers/multi-container-applications/"><em>Docker Compose</em></a>
comes in. We use <code>docker compose</code> to run multiple containers at the same time, including
setting up a network for them to talk to each other, setting up volume mounts to persist
information even after we spin the containers down, allowing ports on your host machiine to
be routed into ports in specific containers etc. The configuration for running multi-container
applications is done in a file typically called <code>docker-compose.yml</code>. Here's an example
which just specifies running our a single container for our worker, which we assume will
be connecting to our cloud instance of Hatchet via an API token specified in the <code>.env</code> file:</p>
<div class="language-yaml highlight"><span class="filename">docker-compose.yml</span><pre><span></span><code><span id="__span-14-1"><a id="__codelineno-14-1" name="__codelineno-14-1" href="#__codelineno-14-1"></a><span class="nt">services</span><span class="p">:</span>
</span><span id="__span-14-2"><a id="__codelineno-14-2" name="__codelineno-14-2" href="#__codelineno-14-2"></a><span class="w">  </span><span class="nt">worker</span><span class="p">:</span>
</span><span id="__span-14-3"><a id="__codelineno-14-3" name="__codelineno-14-3" href="#__codelineno-14-3"></a><span class="w">    </span><span class="nt">build</span><span class="p">:</span>
</span><span id="__span-14-4"><a id="__codelineno-14-4" name="__codelineno-14-4" href="#__codelineno-14-4"></a><span class="w">      </span><span class="nt">context</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">.</span>
</span><span id="__span-14-5"><a id="__codelineno-14-5" name="__codelineno-14-5" href="#__codelineno-14-5"></a><span class="w">      </span><span class="nt">dockerfile</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">Dockerfile.worker</span>
</span><span id="__span-14-6"><a id="__codelineno-14-6" name="__codelineno-14-6" href="#__codelineno-14-6"></a><span class="w">      </span><span class="nt">args</span><span class="p">:</span>
</span><span id="__span-14-7"><a id="__codelineno-14-7" name="__codelineno-14-7" href="#__codelineno-14-7"></a><span class="w">        </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">PYTHON_VERSION=${PYTHON_VERSION:-3.12}</span>
</span><span id="__span-14-8"><a id="__codelineno-14-8" name="__codelineno-14-8" href="#__codelineno-14-8"></a><span class="w">    </span><span class="nt">env_file</span><span class="p">:</span>
</span><span id="__span-14-9"><a id="__codelineno-14-9" name="__codelineno-14-9" href="#__codelineno-14-9"></a><span class="w">      </span><span class="p p-Indicator">-</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">.env</span>
</span><span id="__span-14-10"><a id="__codelineno-14-10" name="__codelineno-14-10" href="#__codelineno-14-10"></a><span class="w">    </span><span class="nt">deploy</span><span class="p">:</span>
</span><span id="__span-14-11"><a id="__codelineno-14-11" name="__codelineno-14-11" href="#__codelineno-14-11"></a><span class="w">      </span><span class="nt">mode</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">replicated</span>
</span><span id="__span-14-12"><a id="__codelineno-14-12" name="__codelineno-14-12" href="#__codelineno-14-12"></a><span class="w">      </span><span class="nt">replicas</span><span class="p">:</span><span class="w"> </span><span class="l l-Scalar l-Scalar-Plain">1</span>
</span></code></pre></div>
<p>We can run this with a simple <code>docker compose up</code>. If we want to run more copies of the
worker, we can also easily bump the <code>replicas</code> up to <code>n</code>. However, We might also want to stand
up Hatchet locally, in which case we can follow the instructions from <a href="https://docs.onhatchet.run/self-hosting/hatchet-lite">Hatchet's official docs</a>
and create a second file called <code>docker-compose.hatchet.yml</code> with their provided contents.</p>
<p>We can run both the container and the worker using the following command:</p>
<div class="language-sh highlight"><pre><span></span><code><span id="__span-15-1"><a id="__codelineno-15-1" name="__codelineno-15-1" href="#__codelineno-15-1"></a>docker<span class="w"> </span>compose<span class="w"> </span>-f<span class="w"> </span>docker-compose.yml<span class="w"> </span>-f<span class="w"> </span>docker-compose.hatchet.yml<span class="w"> </span>up
</span></code></pre></div>
<h4 id="deploying-containers">Deploying containers<a class="headerlink" href="#deploying-containers" title="Permanent link">#</a></h4>
<p>Now that you have a solid mental model of containerization (hopefully), let's briefly talk about how
containers are used in a cloud application. Typically, you have some form of CI/CD pipeline
which is resposnible for testing your code, building containers, and pushing to a repository.</p>
<p>Then, when you deploy your infrastructure, your cloud provider will pull the images from
the repository and run however many of them you ask for - maybe it's controlled by some auto-scaling
logic. In my case, I generally just manually set "a shitload of containers" - e.g. 5000 -
when I am starting an experiment run and then manually set it to "0" when the experiment is
done, rather than worrying about relying on auto-scaling logic which might accidentally
run up a huge bill if it fails to scale down. One reason I like AWS Batch/Fargate is that
you can set a timeout for an entire array job (array as in many fargate instances running the
same container) so there is a safeguard in place that will automatically shut down all containers.</p>
<p>Another common way of controlling costs is to use <code>spot</code> capacity, where your instances
running your containers come at roughly 1/4th the price and are put on machines which are
effectively idling in your cloud provider's data center, BUT they can be terminated at any
time if on-demand customers need them. Typically when this happens, you just get another
instance automatically spun up as soon as its available. Lucky for us, Hatchet's
robust failure/retry handling makes this a complete non-issue - it's totally fine if a
worker goes offline in the middle of a task.</p>
<p>Probably the easiest way to get started with deploying containers in AWS is by using
<em>Elastic Container Service</em> (<a href="https://aws.amazon.com/ecs/"><em>ECS</em></a>). This is a little bit
of a simplification, but you can think of ECS as, essentially, just a way of replicating
what Docker Compose does but in the cloud. You define a <em>cluster</em>, which can have multiple
<em>services</em>. A cluster is backed by compute instances, like EC2, but I typically use Fargate
so that you do not have to worry about actually having a compute cluster backing the service cluster.
Each service in the cluster can be thought of, roughly, as the equivalent of a docker-compose file -
i.e. it can contain multiple containers which you specify images for, commands, environment variables,
exposed ports, etc. Each <em>task</em> within a service is just a replica of that service's task
definition. So if we want 3000 copies of our worker node, we can just specify to run
3000 copies of the relevant service/task.</p>
<h3 id="building-a-mini-cluster-with-your-lab-desktops-overnight-spare-cycles">Building a mini-cluster with your lab desktops' overnight spare cycles<a class="headerlink" href="#building-a-mini-cluster-with-your-lab-desktops-overnight-spare-cycles" title="Permanent link">#</a></h3>
<p>If you're working in an academic lab with access to multiple desktop computers that sit idle overnight, you can create a surprisingly effective compute cluster using Docker Compose. This approach is admittedly lo-fi and a bit janky - e.g. there's no sophisticated scheduling to automatically pause workers when someone arrives to use their computer in the morning (though it's easy enough to add - also someone can just <code>pause</code> their Docker containers...), there's no auto-updating to the latest version of whatever your worker's node container ought to be, etc. But it's also delightfully simple and can provide dramatic speedups for embarrassingly parallel workloads without even worrying about cloud deployments (though these are easy enough and worth getting comfortable with as well). Each machine just needs Docker installed and a simple <code>docker-compose.yml</code> file. No complex cluster management or job scheduling software to maintain.</p>
<p>Rather than fighting for allocation time on shared HPC resources or navigating arcane batch schedulers, you can immediately scale up your experiments across available lab resources.
The basic idea is straightforward: run <code>docker compose up</code> on each spare computer in the lab, with each machine configured to run worker containers that connect to your Hatchet instance (either self-hosted or managed). Even with a modest setup of 10-15 lab desktops, each equipped with 10-24 cores, you can achieve something like a 100-200x speedup compared to running experiments on a single machine. Hatchet will automatically handle balancing workloads across the different compute nodes.</p>
<p>Your lab is essentially subsidizing the electricity, cooling, and infrastructure costs. Those machines would be running anyway (or at least powered on), so you're effectively harvesting otherwise wasted compute cycles. Obviously you should be using this for actual research that is covered by whatever budget covers your lab's costs.</p>
<p>In my opinion, this can create a fun, collaborative dynamic where lab members can contribute their idle resources to accelerate everyone's research. It's a nice way to work together and share resources within the research group, at least every once in a while. Also, if you are the person in your lab who normally ends up managing everyone else's distributed compute, it's a good way to give others an idea about what it takes.</p>
<p>Each machine can be configured with an appropriate number of replicas based on its CPU count - maybe 8 workers for a 12-core machine, leaving some headroom for the OS and other processes and with <code>MAX_RUNS=1</code> for each worker. The <code>.env</code> file contains the Hatchet connection details and any worker configuration.</p>
<p>Workers will continue running until manually stopped, so you'll need to coordinate with lab members about when their machines will be needed. Some labs develop informal protocols around this - maybe workers automatically start at 6 PM and lab members are responsible for stopping them when they arrive in the morning. It's also pretty easy to just manually pause all compute via Hatchet's web dashboard, or do this via cron job of some sort. I'll leave that up to you.</p>
<h3 id="self-hosting-hatchet-as-an-intro-to-cloud-configuration">Self-hosting Hatchet as an intro to cloud configuration<a class="headerlink" href="#self-hosting-hatchet-as-an-intro-to-cloud-configuration" title="Permanent link">#</a></h3>
<p>While I actually think there's a good chance you are likely to be better off using
<a href="https://hatchet.run">the managed Hatchet cloud</a> (see my price comparison with self-hosting
<a href="https://github.com/szvsw/hatchet-sst?tab=readme-ov-file#cost-estimate">here</a>), if we
are looking at what it takes to stand up an open source experiment tracking engine, I
don't think it would be right to do so while relying on managed infra (as wonderfully
easy and convenient as it is)! Plus, for my use-case of simply running a few million
simulations once or twice a month, it's only about $13/day to run the Hatchet engine and then tear
it down when done (rather than paying for the entire stack monthly or for the managed cloud).</p>
<p><a href="https://github.com/hatchet-dev/hatchet">Hatchet</a> is composed of a few pieces - a broker
(RabbitMQ), a database (Postgres), the engine (written in Go - this is where most of
Hatchet's magic happens), a web dashboard (Next) and an API (also in Go). The Hatchet
team has written a bunch of really
<a href="https://docs.hatchet.run/blog/multi-tenant-queues">great blog posts</a> which give you a peek
into the underlying infrastructure, including some of the benefits of using pg as part of
an async queue stack. The <a href="https://github.com/hatchet-dev/hatchet/releases/tag/v0.55.26">release notes</a>
also often include a lot of cool technical details which I encourage you to check out as well.</p>
<p>The official <a href="https://docs.onhatchet.run/self-hosting">Hatchet self-hosting docs</a> already
include deployment instructions for Kubernetes/Helm, but I do not have real experience with
them, so I instead went the route of building out my own infra. The actual
infrastructure-as-code for self-deploying Hatchet that I wrote is all done with
<a href="https://sst.dev">sst.dev</a> + <a href="https://pulumi.com">Pulumi</a>, and can be found with a bunch
of detailed instructions in the <a href="https://github.com/szvsw/hatchet-sst">szvsw/hatchet-sst</a>
repository. This was my first time using both SST &amp; Pulumi, but I have experience with
Terraform as well as AWS Copilot CLI+CloudFormation (blech) as well as plenty of experience
just doing things manually in the console, so picking up SST/Pulumi was straightforwrd enough.</p>
<p>After reading this section, you should have enough knowledge to dive into
<a href="https://github.com/szvsw/hatchet-sst">szvsw/hatchet-sst</a> and start customizing things to
your liking or ripping things out and replacing - or even just rebuilding things on your own
in the AWS Console.</p>
<p>So, let's get into it!</p>
<h4 id="the-vpc">The VPC<a class="headerlink" href="#the-vpc" title="Permanent link">#</a></h4>
<p>When you are at home, you have a whole bunch of resources which all need to talk to each
other, and possibly the internet - your laptop, your smart TV, your cell phone, your printer,
etc. They all sit behind your router and form a network where the devices can talk to
each other via the router without sending messages out over the internet, while some of
them can additionally send or even receive messages from the big internet beyond through
the router. We can think of this cluster of devices as a local private cloud.</p>
<p>On AWS, a <em>Virtual Private Cloud</em> (<em>VPC</em>) can be thought of similarly - it's just where
all of the different pieces of your infrastructure live in a shared network so that they
can find each other and (possibly) talk to the internet, with lots of configurability for
how the resources are allowed to (or not!) communicate with each other, what kinds of traffic
they are allowed to receive, how exposed they are to the internet, etc.</p>
<p>Our VPC itself lives inside of a <em>region</em>, which is just AWS parlance for "a bunch of
datacenters in a particular location, e.g. North Virginia" (<code>us-east-1</code> stans rise up).
Because, for some unknown, mysterious-to-me reasons, these datacenters very occasionally
like to take a mental health day, each region will have a few different
<em>availability zones</em> (<em>AZs</em>), (e.g. <code>us-east-1a</code> or <code>us-east-1b</code>) which are really just
specific subgroups of the actual datacenter buildings within the same region that are
nevertheless separated by enough distance to at least not be affected by the same tornado
(yes, that seems to be an official metric, at least according to the
<a href="https://aws.amazon.com/about-aws/global-infrastructure/regions_az/">AWS marketing</a>). I
like to think of them as being close enough to support the same professional sports teams
but different high school sports teams. It's pretty common practice when setting up your
VPC to specify that it will use two or three availability zones, but for our purposes we
could probably get away with one. For the types of computing I do, I've never really had
to think about AZs much, besides a few pieces of infrastructure which scale their cost
with the number of AZs (like PrivateLink VPC Endpoints).</p>
<p>When the VPC gets created, it typically gets one <em>private subnet</em> and one <em>public subnet</em>
created for each AZ. Resources in the VPC can always find and talk to each other, but
resources in the private subnet cannot cannot reach or be reached by the outside internet
(by default - they can in fact reach the internet with some extra bits and bobs attached) while
resources in the public subnet can automatically reach the external internet (though
not necessarily be reached by it). This is a little bit of a simplification, but it's
the mental model I've always used and it has worked for me. You can think of this as if
you had two routers set up at home, both connected to each other, but only one of them
connected to your internet provider. You might put a device like your printer on the router
that's not connected to the internet, while you would put your smart TV on the one that is.
Of course you could set up some extra tooling to allow you to say, trigger a printout on your home
printer from work, but it would require following specific patterns to do so.</p>
<h4 id="public-vs-private-subnets">Public vs Private Subnets<a class="headerlink" href="#public-vs-private-subnets" title="Permanent link">#</a></h4>
<blockquote>
<p><em>nb: we use the term <code>egress</code> when the resource in question is initiating connections to
some other resource and receiving a response, while <code>ingress</code> would indicate that the resource
in question is open to connections initiated by some other resource and providing responses.
At least that's how I think of it!</em></p>
</blockquote>
<p>Let's think through which subnets to use for each of our resources:</p>
<table>
<thead>
<tr>
<th>Resource</th>
<th>Subnet</th>
<th>Reasoning</th>
</tr>
</thead>
<tbody>
<tr>
<td>Database</td>
<td>Private</td>
<td>The database does definitely does not need any internet egress or ingress. It just needs to be reachable inside the VPC by the Hatchet engine/API.</td>
</tr>
<tr>
<td>Broker</td>
<td>Private</td>
<td>Same as the db.</td>
</tr>
<tr>
<td>Load Balancer</td>
<td>Public</td>
<td>The load balancer will be responsible for routing internet ingress traffic from worker nodes (e.g. deployed locally on your machine) to the engine or API containers, or user traffic on the web UI dashboard to the dashboard container. As such, it definitely needs to be in the public subnet.</td>
</tr>
<tr>
<td>Hatchet Engine</td>
<td>Public or Private</td>
<td>The engine does not inherently need internet egress during operations, so we can definitely put it in a private subnet if we want; however, the service does need to pull container images from Elastic Container Registry (ECR) before starting up, and by default that requires internet egress even though ECR is still in the AWS region; however if we want the engine in a private subnet, we can just add a NAT Gateway or AWS PrivateLink VPC endpoints to allow the private subnet to reach ECR. Now you might be thinking - well, these services might need internet ingress so that local workers outside of the VPC can talk to the engine, and you would be right - but since we are using a load balancer to front the application, the load balancer can be in the public subnet while then routing traffic to the appropriate targets in the private subnet.</td>
</tr>
<tr>
<td>Hatchet Dashboard</td>
<td>Public or Private</td>
<td>Same as above.</td>
</tr>
</tbody>
</table>
<h4 id="security-groups">Security Groups<a class="headerlink" href="#security-groups" title="Permanent link">#</a></h4>
<p><em>Security groups</em> (<em>SGs</em>) are just the logical groupings with rules that allow you to easily define which resources in your
subnet are allowed to talk to which other resources. A security group can have both ingress
and egress rules - who will this group accept incoming traffic from and on what ports/protocol?
Who is this group allowed to send outgoing traffic to and on what ports/protocol? For instance,
suppose you have an EC2 compute instance up in a public subnet with a public IP address assigned
which you want to allow yourself to SSH into. You could create a security group to place
that instance inside of which has a rule that says "allow ssh traffic via TCP/port 22 from <em>my IP address</em>",
(AWS helpfully has a button you can click to resolve your personal IP address automatically).</p>
<p>To keep things simple then, we can just create a default security group that allows each service to send
outbound traffic to any IP on any port and allow inbound traffic on any port but only from
IPs which are inside the VPC. Note that just because the security group allows outbound traffic
doesn't mean every resource can reach the internet (e.g. those in the subnet have no path) -
it just means if it tries to make one such request, it won't get blocked by the security
group's rules. Now this is pretty permissive, even if each resource is only accepting traffic inside
the VPC. Of course, we could be much more precise (less permissive) without much more difficulty:</p>
<p>Clearly, both the Database and the Broker need ingress allowed from the Engine. The Dashboard (which
also includes the API) needs to be able to talk to the Database and possibly the Engine.
The Engine possibly needs to be able to talk to the API. To do that, we just need to
set up specific security groups for each of the resources, and then create the relevant in-
or egress rules. I've done that for the Broker for instance, but am still using the default
SG outlined above for everything else. Want to contribute to <a href="https://github.com/szvsw/hatchet-sst">szvsw/hatchet-sst</a>?
That would be a great and easy first PR!</p>
<h4 id="deploying-the-hatchet-service">Deploying the Hatchet service<a class="headerlink" href="#deploying-the-hatchet-service" title="Permanent link">#</a></h4>
<p>Now that we know about how the VPC is arranged, we can think about what we need to do to
deploy Hatchet:</p>
<ol>
<li>We will need to stand up a Postgres instance and a RabbitMQ instance for the Hatchet engine
   to communicate with. We will do this using Aurora and AmazonMQ respectively and place
   these services in the private subnet.</li>
<li>We will need to stand up the Hatchet dashboard and Hatchet engine, which we will do using ECS
   and the images provided by the Hatchet team (though we will actually be pushing out own version of
   them into ECR). These will be fronted by a load balancer
   (assuming we want access over the internet), but can be placed into a private or public subnet
   as desired. If placing in a private subnet, we will need to either add a NAT gateway or
   AWS PrivateLink VPC Endpoints so that the images can be pulled from ECR.</li>
</ol>
<p>There are some more subtleties around some of this configuration in terms of how Hatchet
initializes the database, how to handle connection strings between services (particularly
if you want the services accessibly simultaneously over the internet AND from inside the VPC
while bypassing the load balancer), handling healthchecks for gRPC ports etc, but this should be enough to get you up to speed with
reading the relatively straightforward infrastructure-as-code (IaC) materials in <a href="https://github.com/szvsw/hatchet-sst">szvsw/hatchet-sst</a>.</p>
<p>Take a look at the next section first, as it will give you a quick overview of how all the pieces
fit together in IaC, though in the (simpler) context of deploying the worker nodes while connecting
to Hatchet cloud.</p>
<h3 id="worker-nodes">Worker nodes<a class="headerlink" href="#worker-nodes" title="Permanent link">#</a></h3>
<p>We will be using <a href="https://sst.dev">sst.dev</a> to deploy workers, as we did with self-hosting Hatchet above. There are lots of very detailed instructions and guides on getting started provided directly
by sst.dev, which I recommend you peruse to get yourself at least mildly familiar with its
patterns. In short though, it lets you easily specify resources to create in AWS (or other
providers) in code and then run simple commands to stand-up, tear down, etc.</p>
<h4 id="creating-an-environment-and-deploying-a-handful-of-workers">Creating an environment and deploying a handful of workers<a class="headerlink" href="#creating-an-environment-and-deploying-a-handful-of-workers" title="Permanent link">#</a></h4>
<p>Typically, I make a directory called <code>infra</code> or something similar inside my repo, and then
run <code>sst init</code>.</p>
<div class="language-sh highlight"><pre><span></span><code><span id="__span-16-1"><a id="__codelineno-16-1" name="__codelineno-16-1" href="#__codelineno-16-1"></a>mkdir<span class="w"> </span>infra
</span><span id="__span-16-2"><a id="__codelineno-16-2" name="__codelineno-16-2" href="#__codelineno-16-2"></a><span class="nb">cd</span><span class="w"> </span>infra
</span><span id="__span-16-3"><a id="__codelineno-16-3" name="__codelineno-16-3" href="#__codelineno-16-3"></a>sst<span class="w"> </span>init
</span></code></pre></div>
<p>This will create a file called <code>sst.config.ts</code> which contains all of the configuration for
deploying a stack in AWS.</p>
<p>As before, we will need a VPC, an ECS cluster, and an ECS service which runs the worker task. If
you are self-hosting Hatchet, you probably will want to deploy the workers in the same VPC
as your Hatchet engine so that you can skip the load balancer in front of the engine and save costs - documentation for that
coming soon (mostly just requires overriding some vpc settings and some connection string urls
which normally are encoded in the client token by providing them
via the worker's env vars). For brevity, I'm just illustrating a typical worker deployment here connecting
to Hatchet cloud, including getting an existing bucket if indicated and ensuring that
the worker nodes have access to that bucket (or creating a new one if an existing bucket
name is not provided).</p>
<p>Probably the main thing to pay attention to is how sst creates a nice clean hierarchy of
resources: The VPC contains an ECS Cluster, which contains an ECS Service, which contains
instructions for how it should be built from a Dockerfile and how it should be handled at runtime
(e.g. how many replica tasks to create, using spot capacity, etc). If we wanted to create
separate services for our "experiment" worker and our "scatter/gather" worker - which is mostly
sitting idle but probably needs higher memory - we easily could.</p>
<div class="language-ts highlight"><span class="filename">sst.config.ts</span><pre><span></span><code><span id="__span-17-1"><a id="__codelineno-17-1" name="__codelineno-17-1" href="#__codelineno-17-1"></a><span class="k">export</span><span class="w"> </span><span class="k">default</span><span class="w"> </span><span class="nx">$config</span><span class="p">({</span>
</span><span id="__span-17-2"><a id="__codelineno-17-2" name="__codelineno-17-2" href="#__codelineno-17-2"></a><span class="w">  </span><span class="nx">app</span><span class="p">(</span><span class="nx">input</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-17-3"><a id="__codelineno-17-3" name="__codelineno-17-3" href="#__codelineno-17-3"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-17-4"><a id="__codelineno-17-4" name="__codelineno-17-4" href="#__codelineno-17-4"></a><span class="w">      </span><span class="nx">name</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;scytheworkers&quot;</span><span class="p">,</span>
</span><span id="__span-17-5"><a id="__codelineno-17-5" name="__codelineno-17-5" href="#__codelineno-17-5"></a><span class="w">      </span><span class="nx">removal</span><span class="o">:</span><span class="w"> </span><span class="kt">input?.stage</span><span class="w"> </span><span class="o">===</span><span class="w"> </span><span class="s2">&quot;production&quot;</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="s2">&quot;retain&quot;</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;remove&quot;</span><span class="p">,</span>
</span><span id="__span-17-6"><a id="__codelineno-17-6" name="__codelineno-17-6" href="#__codelineno-17-6"></a><span class="w">      </span><span class="nx">protect</span><span class="o">:</span><span class="w"> </span><span class="p">[</span><span class="s2">&quot;production&quot;</span><span class="p">].</span><span class="nx">includes</span><span class="p">(</span><span class="nx">input</span><span class="o">?</span><span class="p">.</span><span class="nx">stage</span><span class="p">),</span>
</span><span id="__span-17-7"><a id="__codelineno-17-7" name="__codelineno-17-7" href="#__codelineno-17-7"></a><span class="w">      </span><span class="nx">home</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;aws&quot;</span><span class="p">,</span>
</span><span id="__span-17-8"><a id="__codelineno-17-8" name="__codelineno-17-8" href="#__codelineno-17-8"></a><span class="w">    </span><span class="p">};</span>
</span><span id="__span-17-9"><a id="__codelineno-17-9" name="__codelineno-17-9" href="#__codelineno-17-9"></a><span class="w">  </span><span class="p">},</span>
</span><span id="__span-17-10"><a id="__codelineno-17-10" name="__codelineno-17-10" href="#__codelineno-17-10"></a><span class="w">  </span><span class="k">async</span><span class="w"> </span><span class="nx">run</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-17-11"><a id="__codelineno-17-11" name="__codelineno-17-11" href="#__codelineno-17-11"></a><span class="w">    </span><span class="c1">// TODO: illustrate referencing existing vpc</span>
</span><span id="__span-17-12"><a id="__codelineno-17-12" name="__codelineno-17-12" href="#__codelineno-17-12"></a><span class="w">    </span><span class="c1">// similar to buckets below in order to deploy worker in same</span>
</span><span id="__span-17-13"><a id="__codelineno-17-13" name="__codelineno-17-13" href="#__codelineno-17-13"></a><span class="w">    </span><span class="c1">// vpc as self-hosted Hatchet</span>
</span><span id="__span-17-14"><a id="__codelineno-17-14" name="__codelineno-17-14" href="#__codelineno-17-14"></a><span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">vpc</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">sst</span><span class="p">.</span><span class="nx">aws</span><span class="p">.</span><span class="nx">Vpc</span><span class="p">(</span><span class="s2">&quot;Vpc&quot;</span><span class="p">);</span>
</span><span id="__span-17-15"><a id="__codelineno-17-15" name="__codelineno-17-15" href="#__codelineno-17-15"></a>
</span><span id="__span-17-16"><a id="__codelineno-17-16" name="__codelineno-17-16" href="#__codelineno-17-16"></a><span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">cluster</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">sst</span><span class="p">.</span><span class="nx">aws</span><span class="p">.</span><span class="nx">Cluster</span><span class="p">(</span><span class="s2">&quot;Cluster&quot;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-17-17"><a id="__codelineno-17-17" name="__codelineno-17-17" href="#__codelineno-17-17"></a><span class="w">      </span><span class="nx">vpc</span><span class="p">,</span>
</span><span id="__span-17-18"><a id="__codelineno-17-18" name="__codelineno-17-18" href="#__codelineno-17-18"></a><span class="w">    </span><span class="p">});</span>
</span><span id="__span-17-19"><a id="__codelineno-17-19" name="__codelineno-17-19" href="#__codelineno-17-19"></a>
</span><span id="__span-17-20"><a id="__codelineno-17-20" name="__codelineno-17-20" href="#__codelineno-17-20"></a><span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">hatchetToken</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">sst</span><span class="p">.</span><span class="nx">Secret</span><span class="p">(</span><span class="s2">&quot;HATCHET_CLIENT_TOKEN&quot;</span><span class="p">,</span><span class="w"> </span><span class="s2">&quot;ey&quot;</span><span class="p">);</span>
</span><span id="__span-17-21"><a id="__codelineno-17-21" name="__codelineno-17-21" href="#__codelineno-17-21"></a>
</span><span id="__span-17-22"><a id="__codelineno-17-22" name="__codelineno-17-22" href="#__codelineno-17-22"></a><span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">hatchetTokenSecret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">aws</span><span class="p">.</span><span class="nx">ssm</span><span class="p">.</span><span class="nx">Parameter</span><span class="p">(</span>
</span><span id="__span-17-23"><a id="__codelineno-17-23" name="__codelineno-17-23" href="#__codelineno-17-23"></a><span class="w">      </span><span class="sb">`/</span><span class="si">${</span><span class="nx">$app</span><span class="p">.</span><span class="nx">name</span><span class="si">}</span><span class="sb">/</span><span class="si">${</span><span class="nx">$app</span><span class="p">.</span><span class="nx">stage</span><span class="si">}</span><span class="sb">/HATCHET_CLIENT_TOKEN`</span><span class="p">,</span>
</span><span id="__span-17-24"><a id="__codelineno-17-24" name="__codelineno-17-24" href="#__codelineno-17-24"></a><span class="w">      </span><span class="p">{</span>
</span><span id="__span-17-25"><a id="__codelineno-17-25" name="__codelineno-17-25" href="#__codelineno-17-25"></a><span class="w">        </span><span class="kr">type</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;SecureString&quot;</span><span class="p">,</span>
</span><span id="__span-17-26"><a id="__codelineno-17-26" name="__codelineno-17-26" href="#__codelineno-17-26"></a><span class="w">        </span><span class="nx">value</span><span class="o">:</span><span class="w"> </span><span class="kt">hatchetToken.value</span><span class="p">,</span>
</span><span id="__span-17-27"><a id="__codelineno-17-27" name="__codelineno-17-27" href="#__codelineno-17-27"></a><span class="w">      </span><span class="p">},</span>
</span><span id="__span-17-28"><a id="__codelineno-17-28" name="__codelineno-17-28" href="#__codelineno-17-28"></a><span class="w">    </span><span class="p">);</span>
</span><span id="__span-17-29"><a id="__codelineno-17-29" name="__codelineno-17-29" href="#__codelineno-17-29"></a>
</span><span id="__span-17-30"><a id="__codelineno-17-30" name="__codelineno-17-30" href="#__codelineno-17-30"></a><span class="w">    </span><span class="c1">// Optionally use an existing bucket</span>
</span><span id="__span-17-31"><a id="__codelineno-17-31" name="__codelineno-17-31" href="#__codelineno-17-31"></a><span class="w">    </span><span class="c1">// if `EXISTING_BUCKET` is set</span>
</span><span id="__span-17-32"><a id="__codelineno-17-32" name="__codelineno-17-32" href="#__codelineno-17-32"></a><span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">bucket</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">EXISTING_BUCKET</span>
</span><span id="__span-17-33"><a id="__codelineno-17-33" name="__codelineno-17-33" href="#__codelineno-17-33"></a><span class="w">      </span><span class="o">?</span><span class="w"> </span><span class="nx">aws</span><span class="p">.</span><span class="nx">s3</span><span class="p">.</span><span class="nx">BucketV2</span><span class="p">.</span><span class="nx">get</span><span class="p">(</span><span class="s2">&quot;Storage&quot;</span><span class="p">,</span><span class="w"> </span><span class="nx">process</span><span class="p">.</span><span class="nx">env</span><span class="p">.</span><span class="nx">EXISTING_BUCKET</span><span class="p">)</span>
</span><span id="__span-17-34"><a id="__codelineno-17-34" name="__codelineno-17-34" href="#__codelineno-17-34"></a><span class="w">      </span><span class="o">:</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">sst</span><span class="p">.</span><span class="nx">aws</span><span class="p">.</span><span class="nx">Bucket</span><span class="p">(</span><span class="s2">&quot;Storage&quot;</span><span class="p">);</span>
</span><span id="__span-17-35"><a id="__codelineno-17-35" name="__codelineno-17-35" href="#__codelineno-17-35"></a>
</span><span id="__span-17-36"><a id="__codelineno-17-36" name="__codelineno-17-36" href="#__codelineno-17-36"></a><span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">bucketName</span><span class="w"> </span><span class="o">=</span>
</span><span id="__span-17-37"><a id="__codelineno-17-37" name="__codelineno-17-37" href="#__codelineno-17-37"></a><span class="w">      </span><span class="nx">bucket</span><span class="w"> </span><span class="ow">instanceof</span><span class="w"> </span><span class="nx">aws</span><span class="p">.</span><span class="nx">s3</span><span class="p">.</span><span class="nx">BucketV2</span><span class="w"> </span><span class="o">?</span><span class="w"> </span><span class="nx">bucket.bucket</span><span class="w"> </span><span class="o">:</span><span class="w"> </span><span class="kt">bucket.name</span><span class="p">;</span>
</span><span id="__span-17-38"><a id="__codelineno-17-38" name="__codelineno-17-38" href="#__codelineno-17-38"></a>
</span><span id="__span-17-39"><a id="__codelineno-17-39" name="__codelineno-17-39" href="#__codelineno-17-39"></a><span class="w">    </span><span class="kd">const</span><span class="w"> </span><span class="nx">_service</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="ow">new</span><span class="w"> </span><span class="nx">sst</span><span class="p">.</span><span class="nx">aws</span><span class="p">.</span><span class="nx">Service</span><span class="p">(</span><span class="s2">&quot;Service&quot;</span><span class="p">,</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-17-40"><a id="__codelineno-17-40" name="__codelineno-17-40" href="#__codelineno-17-40"></a><span class="w">      </span><span class="c1">// can be deployed in private subnet if preferred</span>
</span><span id="__span-17-41"><a id="__codelineno-17-41" name="__codelineno-17-41" href="#__codelineno-17-41"></a><span class="w">      </span><span class="c1">// by replacing cluster or using `transform`</span>
</span><span id="__span-17-42"><a id="__codelineno-17-42" name="__codelineno-17-42" href="#__codelineno-17-42"></a><span class="w">      </span><span class="nx">cluster</span><span class="p">,</span>
</span><span id="__span-17-43"><a id="__codelineno-17-43" name="__codelineno-17-43" href="#__codelineno-17-43"></a><span class="w">      </span><span class="c1">// No ingress needed</span>
</span><span id="__span-17-44"><a id="__codelineno-17-44" name="__codelineno-17-44" href="#__codelineno-17-44"></a><span class="w">      </span><span class="nx">loadBalancer</span><span class="o">:</span><span class="w"> </span><span class="kt">undefined</span><span class="p">,</span>
</span><span id="__span-17-45"><a id="__codelineno-17-45" name="__codelineno-17-45" href="#__codelineno-17-45"></a>
</span><span id="__span-17-46"><a id="__codelineno-17-46" name="__codelineno-17-46" href="#__codelineno-17-46"></a><span class="w">      </span><span class="c1">// Instance config</span>
</span><span id="__span-17-47"><a id="__codelineno-17-47" name="__codelineno-17-47" href="#__codelineno-17-47"></a><span class="w">      </span><span class="nx">cpu</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;2 vCPU&quot;</span><span class="p">,</span>
</span><span id="__span-17-48"><a id="__codelineno-17-48" name="__codelineno-17-48" href="#__codelineno-17-48"></a><span class="w">      </span><span class="nx">memory</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;8 GB&quot;</span><span class="p">,</span>
</span><span id="__span-17-49"><a id="__codelineno-17-49" name="__codelineno-17-49" href="#__codelineno-17-49"></a>
</span><span id="__span-17-50"><a id="__codelineno-17-50" name="__codelineno-17-50" href="#__codelineno-17-50"></a><span class="w">      </span><span class="c1">// Scaling/Capacity</span>
</span><span id="__span-17-51"><a id="__codelineno-17-51" name="__codelineno-17-51" href="#__codelineno-17-51"></a><span class="w">      </span><span class="nx">capacity</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;spot&quot;</span><span class="p">,</span>
</span><span id="__span-17-52"><a id="__codelineno-17-52" name="__codelineno-17-52" href="#__codelineno-17-52"></a><span class="w">      </span><span class="nx">scaling</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-17-53"><a id="__codelineno-17-53" name="__codelineno-17-53" href="#__codelineno-17-53"></a><span class="w">        </span><span class="nx">min</span><span class="o">:</span><span class="w"> </span><span class="kt">4</span><span class="p">,</span><span class="w"> </span><span class="c1">// (1)!</span>
</span><span id="__span-17-54"><a id="__codelineno-17-54" name="__codelineno-17-54" href="#__codelineno-17-54"></a><span class="w">        </span><span class="nx">max</span><span class="o">:</span><span class="w"> </span><span class="kt">4</span><span class="p">,</span>
</span><span id="__span-17-55"><a id="__codelineno-17-55" name="__codelineno-17-55" href="#__codelineno-17-55"></a><span class="w">      </span><span class="p">},</span>
</span><span id="__span-17-56"><a id="__codelineno-17-56" name="__codelineno-17-56" href="#__codelineno-17-56"></a>
</span><span id="__span-17-57"><a id="__codelineno-17-57" name="__codelineno-17-57" href="#__codelineno-17-57"></a><span class="w">      </span><span class="c1">// Build</span>
</span><span id="__span-17-58"><a id="__codelineno-17-58" name="__codelineno-17-58" href="#__codelineno-17-58"></a><span class="w">      </span><span class="nx">image</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-17-59"><a id="__codelineno-17-59" name="__codelineno-17-59" href="#__codelineno-17-59"></a><span class="w">        </span><span class="c1">// additional config like target, args, etc work</span>
</span><span id="__span-17-60"><a id="__codelineno-17-60" name="__codelineno-17-60" href="#__codelineno-17-60"></a><span class="w">        </span><span class="nx">context</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;..&quot;</span><span class="p">,</span><span class="w"> </span><span class="c1">// relative to working dir</span>
</span><span id="__span-17-61"><a id="__codelineno-17-61" name="__codelineno-17-61" href="#__codelineno-17-61"></a><span class="w">        </span><span class="nx">dockerfile</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;path/to/your/Dockerfile&quot;</span><span class="p">,</span><span class="w"> </span><span class="c1">// relative to context</span>
</span><span id="__span-17-62"><a id="__codelineno-17-62" name="__codelineno-17-62" href="#__codelineno-17-62"></a><span class="w">      </span><span class="p">},</span>
</span><span id="__span-17-63"><a id="__codelineno-17-63" name="__codelineno-17-63" href="#__codelineno-17-63"></a>
</span><span id="__span-17-64"><a id="__codelineno-17-64" name="__codelineno-17-64" href="#__codelineno-17-64"></a><span class="w">      </span><span class="c1">// Runtime</span>
</span><span id="__span-17-65"><a id="__codelineno-17-65" name="__codelineno-17-65" href="#__codelineno-17-65"></a><span class="w">      </span><span class="nx">environment</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-17-66"><a id="__codelineno-17-66" name="__codelineno-17-66" href="#__codelineno-17-66"></a><span class="w">        </span><span class="nx">SCYTHE_STORAGE_BUCKET</span><span class="o">:</span><span class="w"> </span><span class="kt">bucketName</span><span class="p">,</span>
</span><span id="__span-17-67"><a id="__codelineno-17-67" name="__codelineno-17-67" href="#__codelineno-17-67"></a><span class="w">        </span><span class="nx">SCYTHE_TIMEOUT_SCATTER_GATHER_SCHEDULE</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;100m&quot;</span><span class="p">,</span>
</span><span id="__span-17-68"><a id="__codelineno-17-68" name="__codelineno-17-68" href="#__codelineno-17-68"></a><span class="w">        </span><span class="nx">SCYTHE_TIMEOUT_SCATTER_GATHER_EXECUTION</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;200m&quot;</span><span class="p">,</span>
</span><span id="__span-17-69"><a id="__codelineno-17-69" name="__codelineno-17-69" href="#__codelineno-17-69"></a><span class="w">        </span><span class="nx">SCYTHE_TIMEOUT_EXPERIMENT_SCHEDULE</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;10m&quot;</span><span class="p">,</span>
</span><span id="__span-17-70"><a id="__codelineno-17-70" name="__codelineno-17-70" href="#__codelineno-17-70"></a><span class="w">        </span><span class="nx">SCYTHE_TIMEOUT_EXPERIMENT_EXECUTION</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;2m&quot;</span><span class="p">,</span>
</span><span id="__span-17-71"><a id="__codelineno-17-71" name="__codelineno-17-71" href="#__codelineno-17-71"></a><span class="w">        </span><span class="nx">SCYTHE_WORKER_HIGH_MEMORY</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;false&quot;</span><span class="p">,</span>
</span><span id="__span-17-72"><a id="__codelineno-17-72" name="__codelineno-17-72" href="#__codelineno-17-72"></a><span class="w">        </span><span class="nx">SCYTHE_WORKER_HIGH_CPU</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;false&quot;</span><span class="p">,</span>
</span><span id="__span-17-73"><a id="__codelineno-17-73" name="__codelineno-17-73" href="#__codelineno-17-73"></a><span class="w">        </span><span class="nx">SCYTHE_WORKER_SLOTS</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;1&quot;</span><span class="p">,</span><span class="w"> </span><span class="c1">// Only allow a single task per worker</span>
</span><span id="__span-17-74"><a id="__codelineno-17-74" name="__codelineno-17-74" href="#__codelineno-17-74"></a><span class="w">      </span><span class="p">},</span>
</span><span id="__span-17-75"><a id="__codelineno-17-75" name="__codelineno-17-75" href="#__codelineno-17-75"></a><span class="w">      </span><span class="nx">ssm</span><span class="o">:</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-17-76"><a id="__codelineno-17-76" name="__codelineno-17-76" href="#__codelineno-17-76"></a><span class="w">        </span><span class="nx">HATCHET_CLIENT_TOKEN</span><span class="o">:</span><span class="w"> </span><span class="kt">hatchetTokenSecret.arn</span><span class="p">,</span>
</span><span id="__span-17-77"><a id="__codelineno-17-77" name="__codelineno-17-77" href="#__codelineno-17-77"></a><span class="w">      </span><span class="p">},</span>
</span><span id="__span-17-78"><a id="__codelineno-17-78" name="__codelineno-17-78" href="#__codelineno-17-78"></a>
</span><span id="__span-17-79"><a id="__codelineno-17-79" name="__codelineno-17-79" href="#__codelineno-17-79"></a><span class="w">      </span><span class="nx">link</span><span class="o">:</span><span class="w"> </span><span class="p">[</span><span class="nx">bucket</span><span class="p">],</span>
</span><span id="__span-17-80"><a id="__codelineno-17-80" name="__codelineno-17-80" href="#__codelineno-17-80"></a><span class="w">    </span><span class="p">});</span>
</span><span id="__span-17-81"><a id="__codelineno-17-81" name="__codelineno-17-81" href="#__codelineno-17-81"></a>
</span><span id="__span-17-82"><a id="__codelineno-17-82" name="__codelineno-17-82" href="#__codelineno-17-82"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-17-83"><a id="__codelineno-17-83" name="__codelineno-17-83" href="#__codelineno-17-83"></a><span class="w">      </span><span class="nx">bucket</span><span class="o">:</span><span class="w"> </span><span class="kt">bucketName</span><span class="p">,</span>
</span><span id="__span-17-84"><a id="__codelineno-17-84" name="__codelineno-17-84" href="#__codelineno-17-84"></a><span class="w">    </span><span class="p">};</span>
</span><span id="__span-17-85"><a id="__codelineno-17-85" name="__codelineno-17-85" href="#__codelineno-17-85"></a><span class="w">  </span><span class="p">},</span>
</span><span id="__span-17-86"><a id="__codelineno-17-86" name="__codelineno-17-86" href="#__codelineno-17-86"></a><span class="p">});</span>
</span></code></pre></div>
<ol>
<li>Set these to super-high numbers to max out your parallelism - and costs!</li>
</ol>
<p>Now that our config is all set up, we are ready to specify our <code>HATCHET_CLIENT_TOKEN</code> (retrieved
from the Hatchet web dashboard) as an <code>sst secret</code> and then deploy our application.</p>
<div class="language-sh highlight"><pre><span></span><code><span id="__span-18-1"><a id="__codelineno-18-1" name="__codelineno-18-1" href="#__codelineno-18-1"></a>sst<span class="w"> </span>secret<span class="w"> </span><span class="nb">set</span><span class="w"> </span>HATCHET_CLIENT_TOKEN
</span><span id="__span-18-2"><a id="__codelineno-18-2" name="__codelineno-18-2" href="#__codelineno-18-2"></a>sst<span class="w"> </span>deploy
</span></code></pre></div>
<h4 id="deploying-a-lot-of-workers-at-once">Deploying a lot of workers at once<a class="headerlink" href="#deploying-a-lot-of-workers-at-once" title="Permanent link">#</a></h4>
<p>In the example above, we are just deploying 4 workers using spot capacity to save costs -
but we can bump that number up to about 5000 min/max if we want to reach our service quota
limit for ECS tasks, which is hardlocked at 5k I believe. Note that you probably will need to request a quota bump on ECS Fargate vCPU count - for instance in the example above with 5000 ECS tasks for
that service, we would need a service quota of 10k simultaneous vCPUs. You would also need
the appropriate tenant limits on your Hatchet tenant (either in Hatchet cloud or on self-hosted)
to allow that many simultaneous worker connections, and an appropriately sized/scaled db
instance and engine instance(s) (which scale horizontally but probably require connection pooling
past a couple).</p>
<p>We could of course make min != max and use some simple cpu/memory thresholds (configurable inline within
sst.dev) to handle auto-scaling worker nodes, but for my case I generally prefer to just
be responsible for manually setting that desired count up to max parallelism and then back
down to 0 when I am done - or <code>sst remove</code>-ing the entire stack - rather than relying on
autoscaling to safely spin things down. Since I'm only running sims at serious scale
once or twice a month (or sometimes months plural), it's not a bother at all.</p>
<h4 id="differentiating-worker-types">Differentiating worker types<a class="headerlink" href="#differentiating-worker-types" title="Permanent link">#</a></h4>
<div class="language-ts highlight"><pre><span></span><code><span id="__span-19-1"><a id="__codelineno-19-1" name="__codelineno-19-1" href="#__codelineno-19-1"></a><span class="kd">const</span><span class="w"> </span><span class="nx">environment</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">{</span>
</span><span id="__span-19-2"><a id="__codelineno-19-2" name="__codelineno-19-2" href="#__codelineno-19-2"></a><span class="w">  </span><span class="p">...,</span>
</span><span id="__span-19-3"><a id="__codelineno-19-3" name="__codelineno-19-3" href="#__codelineno-19-3"></a><span class="w">  </span><span class="nx">SCYTHE_WORKER_HIGH_MEMORY</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;true&quot;</span><span class="p">,</span>
</span><span id="__span-19-4"><a id="__codelineno-19-4" name="__codelineno-19-4" href="#__codelineno-19-4"></a><span class="w">  </span><span class="nx">SCYTHE_WORKER_HIGH_CPU</span><span class="o">:</span><span class="w"> </span><span class="s2">&quot;true&quot;</span><span class="p">,</span>
</span><span id="__span-19-5"><a id="__codelineno-19-5" name="__codelineno-19-5" href="#__codelineno-19-5"></a><span class="p">}</span>
</span></code></pre></div>
<p>This will automatically add the <code>HIGH_CPU</code> and <code>HIGH_MEMORY</code> tags to your workers (or you could
do just one, or neither of course) and then specify on your tasks that they require one or the other (or both!).
This can be useful to e.g. differentiate your <code>scatter/gather</code> workers from your main experiment workers
without needing to carefully control which tasks the workers register.</p>
<p><em>TODO: illustrate indicating that a task requires high memory or cpu</em></p>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
          <button type="button" class="md-top md-icon" data-md-component="top" hidden>
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8z"/></svg>
  Back to top
</button>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
    <div class="md-copyright__highlight">
      Maintained by <a href="https://github.com/szvsw">Sam Wolk</a>.
    </div>
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
        <div class="md-social">
  
    
    
    
    
      
      
    
    <a href="https://github.com/szvsw/scythe" target="_blank" rel="noopener" title="github.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 496 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M165.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M244.8 8C106.1 8 0 113.3 0 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C428.2 457.8 496 362.9 496 252 496 113.3 383.5 8 244.8 8M97.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg>
    </a>
  
    
    
    
    
      
      
    
    <a href="https://pypi.org/project/scythe-engine" target="_blank" rel="noopener" title="pypi.org" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.7.2 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M439.8 200.5c-7.7-30.9-22.3-54.2-53.4-54.2h-40.1v47.4c0 36.8-31.2 67.8-66.8 67.8H172.7c-29.2 0-53.4 25-53.4 54.3v101.8c0 29 25.2 46 53.4 54.3 33.8 9.9 66.3 11.7 106.8 0 26.9-7.8 53.4-23.5 53.4-54.3v-40.7H226.2v-13.6h160.2c31.1 0 42.6-21.7 53.4-54.2 11.2-33.5 10.7-65.7 0-108.6M286.2 404c11.1 0 20.1 9.1 20.1 20.3 0 11.3-9 20.4-20.1 20.4-11 0-20.1-9.2-20.1-20.4.1-11.3 9.1-20.3 20.1-20.3M167.8 248.1h106.8c29.7 0 53.4-24.5 53.4-54.3V91.9c0-29-24.4-50.7-53.4-55.6-35.8-5.9-74.7-5.6-106.8.1-45.2 8-53.4 24.7-53.4 55.6v40.7h106.9v13.6h-147c-31.1 0-58.3 18.7-66.8 54.2-9.8 40.7-10.2 66.1 0 108.6 7.6 31.6 25.7 54.2 56.8 54.2H101v-48.8c0-35.3 30.5-66.4 66.8-66.4m-6.7-142.6c-11.1 0-20.1-9.1-20.1-20.3.1-11.3 9-20.4 20.1-20.4 11 0 20.1 9.2 20.1 20.4s-9 20.3-20.1 20.3"/></svg>
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
      <div class="md-progress" data-md-component="progress" role="progressbar"></div>
    
    
    
      
      <script id="__config" type="application/json">{"base": "../..", "features": ["content.code.annotate", "navigation.top", "navigation.path", "navigation.indexes", "navigation.sections", "navigation.tracking", "navigation.instant", "navigation.instant.prefetch", "navigation.instant.progress"], "search": "../../assets/javascripts/workers/search.d50fe291.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script>
    
    
      <script src="../../assets/javascripts/bundle.56ea9cef.min.js"></script>
      
    
  </body>
</html>